import React, { useState, useEffect, useCallback } from 'react';
import { Mail, UserPlus, Trash2, Shield, AlertTriangle, CheckCircle } from 'lucide-react';

// -----------------------------------------------------------------------------
// 模擬資料庫與驗證服務
// -----------------------------------------------------------------------------
const MOCK_DB = {
  users: [
    { id: 'user-001', email: 'alice@example.com', name: 'Alice', isVerified: true, role: 'Admin' },
    { id: 'user-002', email: 'bob@example.com', name: 'Bob', isVerified: false, role: 'User' },
    { id: 'user-003', email: 'charlie@example.com', name: 'Charlie', isVerified: true, role: 'User' },
  ],
  projects: [
    { id: 'proj-001', name: '專案 A - 網站開發' },
    { id: 'proj-002', name: '專案 B - 行銷活動' },
    { id: 'proj-003', name: '專案 C - 產品研究' },
  ]
};

// 模擬當前登入的管理員
const CURRENT_ADMIN_ID = 'user-001';
const ADMIN_EMAIL = 'admin@mock.com';

// -----------------------------------------------------------------------------
// App 組件
// -----------------------------------------------------------------------------

const App = () => {
  const [users, setUsers] = useState(MOCK_DB.users);
  const [projects, setProjects] = useState(MOCK_DB.projects);
  const [activeTab, setActiveTab] = useState('userVerification');
  const [message, setMessage] = useState(null); // { type: 'success' | 'error', text: '...' }

  const showMessage = (type, text) => {
    setMessage({ type, text });
    setTimeout(() => setMessage(null), 4000); // 4秒後清除訊息
  };

  // 模擬使用者註冊後，需要驗證信件的介面
  const UserVerificationSection = () => (
    <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
      <h2 className="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
        <Mail className="w-6 h-6 mr-2" />
        使用者註冊與郵件驗證 (流程模擬)
      </h2>
      <p className="text-gray-600 mb-4">
        這是針對「使用者註冊後需透過郵件驗證」的功能展示。
        在真實應用中，註冊流程會自動發送一封驗證信給用戶。
      </p>
      <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg">
        <p className="font-semibold text-blue-800">
          <CheckCircle className="inline w-5 h-5 mr-2 align-text-bottom" />
          流程提示：
        </p>
        <ul className="mt-2 list-disc list-inside text-blue-700">
          <li>使用者提交註冊表單。</li>
          <li>系統向註冊電子郵件發送一個帶有唯一連結的驗證信。</li>
          <li>使用者點擊連結後，其帳戶狀態 (`isVerified`) 將從 `false` 變為 `true`。</li>
        </ul>
      </div>
      <div className="mt-6 flex items-center space-x-4">
          <input
            type="email"
            defaultValue="new_user@example.com"
            className="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="輸入模擬註冊電子郵件"
            readOnly
          />
          <button
            onClick={() => showMessage('success', '模擬：驗證信已發送到 new_user@example.com。請檢查信箱！')}
            className="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150"
          >
            模擬註冊 & 發送驗證信
          </button>
      </div>
    </div>
  );

  // 管理員新增/刪除使用者
  const UserManagementSection = () => {
    const [newEmail, setNewEmail] = useState('');
    const [newName, setNewName] = useState('');

    // 2. 管理員可以自行新增用戶
    const handleAddUser = (e) => {
      e.preventDefault();
      if (!newEmail || !newName) {
        showMessage('error', '電子郵件和姓名不能為空。');
        return;
      }
      const newUserId = `user-${String(users.length + 1).padStart(3, '0')}`;
      const newUser = {
        id: newUserId,
        email: newEmail,
        name: newName,
        isVerified: true, // 管理員新增預設為已驗證
        role: 'User'
      };
      setUsers([...users, newUser]);
      setNewEmail('');
      setNewName('');
      showMessage('success', `成功新增用戶：${newName} (${newEmail})`);
    };

    // 2. 管理員可以刪除用戶
    const handleDeleteUser = (userId, userName) => {
      if (userId === CURRENT_ADMIN_ID) {
        showMessage('error', '不能刪除當前登入的管理員帳戶！');
        return;
      }
      if (window.confirm(`確定要刪除用戶 ${userName} 嗎？`)) {
        setUsers(users.filter(user => user.id !== userId));
        showMessage('success', `已成功刪除用戶：${userName}`);
      }
    };

    return (
      <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
        <h2 className="text-2xl font-bold text-green-700 mb-4 flex items-center">
          <Shield className="w-6 h-6 mr-2" />
          管理員：用戶管理
        </h2>

        {/* 新增用戶表單 */}
        <form onSubmit={handleAddUser} className="mb-8 p-4 border border-green-200 rounded-lg bg-green-50">
          <h3 className="text-xl font-semibold text-green-800 mb-3 flex items-center"><UserPlus className="w-5 h-5 mr-2" /> 新增用戶</h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input
              type="text"
              value={newName}
              onChange={(e) => setNewName(e.target.value)}
              className="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
              placeholder="姓名"
            />
            <input
              type="email"
              value={newEmail}
              onChange={(e) => setNewEmail(e.target.value)}
              className="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
              placeholder="電子郵件 (Email)"
            />
            <button
              type="submit"
              className="py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150"
            >
              新增用戶
            </button>
          </div>
        </form>

        {/* 用戶列表 */}
        <h3 className="text-xl font-semibold text-gray-700 mb-3">用戶列表 ({users.length} 人)</h3>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名/角色</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">電子郵件</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">驗證狀態</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr key={user.id} className={user.id === CURRENT_ADMIN_ID ? 'bg-yellow-50' : ''}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-medium text-gray-900">{user.name}</div>
                    <div className="text-xs text-indigo-500">{user.role} {user.id === CURRENT_ADMIN_ID && '(當前管理員)'}</div>
                  </td>
                  <td className="px

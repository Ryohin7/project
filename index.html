<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¡ˆå„€è¡¨æ¿ - å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¨­å®š Tailwind CSS é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«”å’Œæ¨™æº–è‰²èª¿ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-500': '#4f46e5', // Indigo-600
                        'primary-600': '#4338ca', // Indigo-700
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs (ä½¿ç”¨å…¼å®¹ç‰ˆæœ¬) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- React & ReactDOM (æŒ‡å®šç‰ˆæœ¬ 18.2.0) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // ----------------------------------------------------------------------
        // 0. CONSTANTS & UTILITIES
        // ----------------------------------------------------------------------
        
        // ** Canvas ç’°å¢ƒ App ID **
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ** Firestore Collection Paths **
        const PROJECTS_PATH = `artifacts/${appId}/public/data/projects`;
        const ASSIGNEES_PATH = `artifacts/${appId}/public/data/assignees`;

        // å°ˆæ¡ˆç‹€æ…‹é¸é …
        const STATUS_OPTIONS = ['New', 'In Progress', 'Completed'];
        
        // æä¾›çš„ Firebase è¨­å®šä½œç‚º fallback (è‹¥ Canvas ç’°å¢ƒæœªæä¾›å‰‡ä½¿ç”¨æ­¤é…ç½®)
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyCMiLg3coEoLeVtLmfEK_zlAHsHZ-yZfP0",
            authDomain: "project-407d1.firebaseapp.com",
            projectId: "project-407d1",
            storageBucket: "project-407d1.firebasestorage.app",
            messagingSenderId: "524548363140",
            appId: "1:524548363140:web:7b7dedc2a70faf5790c3d1",
            measurementId: "G-QXYBX3MFXE"
        };
        
        // å„ªå…ˆä½¿ç”¨ Canvas ç’°å¢ƒæä¾›çš„è¨­å®š (__firebase_config)ï¼Œå¦å‰‡ä½¿ç”¨é è¨­é…ç½®
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : defaultFirebaseConfig;

        let app;
        let db;
        let authInstance;
        
        const initFirebase = async () => {
            try {
                if (app) return { db, authInstance };
                
                // åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼
                app = firebase.initializeApp(firebaseConfig);
                authInstance = firebase.auth(app);
                db = firebase.firestore(app);
                
                // è™•ç† Canvas Custom Token æˆ–åŒ¿åç™»å…¥
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                console.log(`Firebase Init: Attempting sign-in (Token provided: ${!!token})`);
                
                if (token) {
                    await authInstance.signInWithCustomToken(token);
                } else {
                    await authInstance.signInAnonymously();
                }
                
                return { db, authInstance };
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–æˆ–ç™»å…¥å¤±æ•—:", error);
                return { db: null, authInstance: null };
            }
        };

        // ----------------------------------------------------------------------
        // 1. ICON COMPONENTS (Reusable SVGs)
        // ----------------------------------------------------------------------
        
        const IconWrapper = ({ children, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Users = (props) => (
            <IconWrapper {...props}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </IconWrapper>
        );
        
        const PlusCircle = (props) => (
            <IconWrapper {...props}>
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="16" />
                <line x1="8" y1="12" x2="16" y2="12" />
            </IconWrapper>
        );

        const CheckCircle = (props) => (
            <IconWrapper {...props}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </IconWrapper>
        );

        const XCircle = (props) => (
            <IconWrapper {...props}>
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
            </IconWrapper>
        );

        const AlertTriangle = (props) => (
            <IconWrapper {...props}>
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
            </IconWrapper>
        );


        // ----------------------------------------------------------------------
        // 2. REUSABLE UI COMPONENTS
        // ----------------------------------------------------------------------

        /**
         * å°ˆæ¡ˆç‹€æ…‹æ¨™ç±¤
         */
        const StatusBadge = ({ status }) => {
            let style = 'bg-gray-100 text-gray-800';
            switch (status) {
                case 'New': style = 'bg-red-100 text-red-700 ring-red-500/10'; break;
                case 'In Progress': style = 'bg-primary-50 text-primary-600 ring-primary-500/10'; break;
                case 'Completed': style = 'bg-green-100 text-green-700 ring-green-500/10'; break;
                default: style = 'bg-gray-100 text-gray-700 ring-gray-500/10';
            }
            return (
                <span className={`inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ${style} ring-1 ring-inset`}>
                    {status}
                </span>
            );
        };

        /**
         * é€šç”¨æ¨¡æ…‹æ¡†
         */
        const Modal = ({ isOpen, title, children, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg transition-transform duration-300 transform scale-100" onClick={(e) => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-center border-b border-gray-100 pb-4 mb-4">
                                <h3 className="text-xl font-bold text-gray-900">{title}</h3>
                                <button 
                                    onClick={onClose} 
                                    className="text-gray-400 hover:text-gray-600 transition p-1 rounded-full hover:bg-gray-100"
                                >
                                    <XCircle className="w-6 h-6" />
                                </button>
                            </div>
                            <div>
                                {children}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * æ¨¡æ“¬éƒµä»¶é€šçŸ¥æ¨¡æ…‹æ¡†
         */
        const EmailNotificationModal = ({ isOpen, emailContent, onClose }) => {
            return (
                <Modal 
                    isOpen={isOpen} 
                    title="æ¨¡æ“¬éƒµä»¶é€šçŸ¥" 
                    onClose={onClose}
                >
                    <p className="text-sm text-gray-600 mb-4">é€™å°æ¨¡æ“¬éƒµä»¶å°‡æœƒç™¼é€çµ¦æ–°çš„è™•ç†äººä»¥é€²è¡Œé€šçŸ¥ã€‚</p>
                    {emailContent && (
                        <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <p className="text-sm font-semibold mb-2 text-gray-800">æ”¶ä»¶äºº: <span className="font-normal text-gray-600">{emailContent.to}</span></p>
                            <p className="text-sm font-semibold mb-3 text-gray-800">ä¸»æ—¨: <span className="font-normal text-gray-600">{emailContent.subject}</span></p>
                            <div className="border-t pt-3">
                                <h4 className="text-xs font-medium text-gray-500 uppercase mb-2">éƒµä»¶å…§å®¹:</h4>
                                <pre className="whitespace-pre-wrap font-mono text-sm text-gray-700 bg-white p-3 rounded-md border">{emailContent.body}</pre>
                            </div>
                        </div>
                    )}
                    <div className="flex justify-end mt-4">
                        <button
                            onClick={onClose}
                            className="px-4 py-2 text-sm font-medium text-white bg-primary-500 rounded-lg shadow-md hover:bg-primary-600 transition"
                        >
                            é—œé–‰
                        </button>
                    </div>
                </Modal>
            );
        };
        
        /**
         * æ›´æ›è™•ç†äººè¡¨å–®
         */
        const AssigneeChangeForm = ({ db, projectId, projectName, currentAssigneeId, assignees, onClose, showNotification, openEmailModal }) => {
            const [selectedAssigneeId, setSelectedAssigneeId] = useState(currentAssigneeId);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                
                try {
                    const projectRef = db.collection(PROJECTS_PATH).doc(projectId);
                    await projectRef.update({
                        assigneeId: selectedAssigneeId,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });

                    const newAssignee = assignees.find(a => a.id === selectedAssigneeId) || { name: 'æœªçŸ¥', email: '' };
                    const oldAssignee = assignees.find(a => a.id === currentAssigneeId) || { name: 'æœªçŸ¥' };

                    showNotification('success', `æˆåŠŸå°‡å°ˆæ¡ˆ [${projectName}] è½‰äº¤çµ¦ ${newAssignee.name} è™•ç†ã€‚`);
                    
                    // æ¨¡æ“¬ç™¼é€éƒµä»¶é€šçŸ¥
                    openEmailModal(
                        newAssignee.email || 'N/A', 
                        `ã€å°ˆæ¡ˆè½‰ç§»é€šçŸ¥ã€‘æ‚¨ç¾åœ¨æ˜¯å°ˆæ¡ˆ [${projectName}] çš„è™•ç†äºº`,
                        `æ‚¨å¥½ ${newAssignee.name},\n\nå°ˆæ¡ˆ [${projectName}] å·²æ–¼ ${new Date().toLocaleString()} è½‰äº¤çµ¦æ‚¨è™•ç†ã€‚\n\nåŸè™•ç†äººï¼š${oldAssignee.name}\n\nè«‹ç™»å…¥å„€è¡¨æ¿æŸ¥çœ‹è©³æƒ…ä¸¦é–‹å§‹è™•ç†ã€‚\n\nè¬è¬!`
                    );

                    onClose();
                } catch (error) {
                    console.error("æ›´æ–°è™•ç†äººå¤±æ•—:", error);
                    showNotification('error', 'æ›´æ–°è™•ç†äººå¤±æ•—ã€‚è«‹æª¢æŸ¥ Console ç²å–è©³ç´°è³‡è¨Šã€‚');
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            const currentAssignee = assignees.find(a => a.id === currentAssigneeId)?.name || 'æœªæŒ‡æ´¾';
            
            return (
                <form onSubmit={handleSubmit}>
                    <div className="p-3 bg-indigo-50 border border-indigo-200 rounded-lg mb-6">
                        <p className="text-sm font-medium text-indigo-700">
                            å°ˆæ¡ˆ: <strong className="text-indigo-900">{projectName}</strong>
                        </p>
                        <p className="text-xs text-indigo-600 mt-1">
                            ç›®å‰è™•ç†äºº: <strong>{currentAssignee}</strong>
                        </p>
                    </div>
                    <div className="mb-6">
                        <label htmlFor="assignee-select" className="block text-sm font-semibold text-gray-700 mb-2">é¸æ“‡æ–°çš„è™•ç†äºº</label>
                        <select
                            id="assignee-select"
                            value={selectedAssigneeId}
                            onChange={(e) => setSelectedAssigneeId(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                            required
                            disabled={isSubmitting}
                        >
                            <option value="">-- è«‹é¸æ“‡è™•ç†äºº --</option>
                            {assignees.map((a) => (
                                <option key={a.id} value={a.id}>
                                    {a.name} ({a.email})
                                </option>
                            ))}
                        </select>
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button 
                            type="button" 
                            onClick={onClose} 
                            className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                            disabled={isSubmitting}
                        >
                            å–æ¶ˆ
                        </button>
                        <button 
                            type="submit" 
                            className="px-4 py-2 text-sm font-medium text-white bg-primary-500 rounded-lg shadow-md hover:bg-primary-600 transition disabled:bg-primary-400"
                            disabled={isSubmitting || !selectedAssigneeId || selectedAssigneeId === currentAssigneeId}
                        >
                            {isSubmitting ? 'æ›´æ›ä¸­...' : 'ç¢ºèªæ›´æ›'}
                        </button>
                    </div>
                </form>
            );
        };
        
        /**
         * æ–°å¢å°ˆæ¡ˆè¡¨å–® (æ¨¡æ“¬ç®¡ç†å“¡åŠŸèƒ½)
         */
        const AddProjectForm = ({ db, assignees, onClose, showNotification }) => {
            const [name, setName] = useState('');
            const [status, setStatus] = useState(STATUS_OPTIONS[0]); // Default to 'New'
            const [assigneeId, setAssigneeId] = useState(''); // Allow unassigned
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim()) return;

                setIsSubmitting(true);
                
                try {
                    const newProject = {
                        name: name.trim(),
                        status: status,
                        assigneeId: assigneeId || null, // Allow null assignee
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    };
                    
                    await db.collection(PROJECTS_PATH).add(newProject);

                    showNotification('success', `æˆåŠŸæ–°å¢å°ˆæ¡ˆ: [${name.trim()}]ã€‚`);
                    onClose();
                } catch (error) {
                    console.error("æ–°å¢å°ˆæ¡ˆå¤±æ•—:", error);
                    showNotification('error', 'æ–°å¢å°ˆæ¡ˆå¤±æ•—ã€‚è«‹æª¢æŸ¥ Console ç²å–è©³ç´°è³‡è¨Šã€‚');
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            return (
                <form onSubmit={handleSubmit}>
                    <div className="space-y-4">
                        {/* Project Name */}
                        <div>
                            <label htmlFor="project-name" className="block text-sm font-semibold text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                            <input
                                id="project-name"
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="è¼¸å…¥æ–°å°ˆæ¡ˆåç¨±"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                required
                                disabled={isSubmitting}
                            />
                        </div>

                        {/* Status */}
                        <div>
                            <label htmlFor="project-status" className="block text-sm font-semibold text-gray-700 mb-1">å°ˆæ¡ˆç‹€æ…‹</label>
                            <select
                                id="project-status"
                                value={status}
                                onChange={(e) => setStatus(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                disabled={isSubmitting}
                            >
                                {STATUS_OPTIONS.map((s) => (
                                    <option key={s} value={s}>{s}</option>
                                ))}
                            </select>
                        </div>

                        {/* Assignee */}
                        <div>
                            <label htmlFor="project-assignee" className="block text-sm font-semibold text-gray-700 mb-1">æŒ‡æ´¾è™•ç†äºº (é¸å¡«)</label>
                            <select
                                id="project-assignee"
                                value={assigneeId}
                                onChange={(e) => setAssigneeId(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                disabled={isSubmitting}
                            >
                                <option value="">-- æœªæŒ‡æ´¾ (å¯ç¨å¾ŒæŒ‡æ´¾) --</option>
                                {assignees.map((a) => (
                                    <option key={a.id} value={a.id}>
                                        {a.name} ({a.email})
                                    </option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="flex justify-end space-x-3 mt-6">
                        <button 
                            type="button" 
                            onClick={onClose} 
                            className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                            disabled={isSubmitting}
                        >
                            å–æ¶ˆ
                        </button>
                        <button 
                            type="submit" 
                            className="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition disabled:bg-green-400"
                            disabled={isSubmitting || !name.trim()}
                        >
                            {isSubmitting ? 'æ–°å¢ä¸­...' : 'ç¢ºèªæ–°å¢å°ˆæ¡ˆ'}
                        </button>
                    </div>
                </form>
            );
        };


        // ----------------------------------------------------------------------
        // 3. MAIN APPLICATION COMPONENT
        // ----------------------------------------------------------------------

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [projects, setProjects] = useState([]);
            const [assignees, setAssignees] = useState([]);
            const [userId, setUserId] = useState(null); // åˆå§‹åŒ–ç‚º null
            const [loading, setLoading] = useState(true); // åˆå§‹ç‚º trueï¼Œç›´åˆ° Auth ç‹€æ…‹ç¢ºå®š
            const [isDbConnected, setIsDbConnected] = useState(true);

            // é€šçŸ¥å’Œæ¨¡æ…‹æ¡†ç‹€æ…‹
            const [notification, setNotification] = useState({ visible: false, type: 'success', message: '' });
            const [emailModalConfig, setEmailModalConfig] = useState({
                isOpen: false,
                emailContent: { to: '', subject: '', body: '' }
            });
            const [assigneeModalConfig, setAssigneeModalConfig] = useState({
                isOpen: false,
                projectId: null,
                projectName: '',
                currentAssigneeId: null,
            });
            const [addProjectModalOpen, setAddProjectModalOpen] = useState(false); // æ–°å¢å°ˆæ¡ˆæ¨¡æ…‹æ¡†ç‹€æ…‹

            // é¡¯ç¤ºé€šçŸ¥çš„ useCallback
            const showNotification = useCallback((type, message) => {
                setNotification({ visible: true, type, message });
                setTimeout(() => {
                    setNotification({ visible: false, type, message: '' });
                }, 4000);
            }, []);

            // é–‹å•Ÿéƒµä»¶é€šçŸ¥æ¨¡æ…‹æ¡†
            const openEmailModal = (to, subject, body) => {
                setEmailModalConfig({
                    isOpen: true,
                    emailContent: { to, subject, body }
                });
            };

            // 1. Firebase åˆå§‹åŒ–
            useEffect(() => {
                initFirebase().then(({ db: initializedDb, auth: initializedAuth }) => {
                    setDb(initializedDb);
                    setAuth(initializedAuth);
                    // ğŸš¨ èˆŠï¼šsetLoading(false); -> ç§»é™¤ï¼Œæ”¹ç”± onAuthStateChanged è™•ç†
                });
            }, []);
            
            // 2. ç›£è½ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹ä¸¦æ¨™è¨˜èªè­‰å®Œæˆ (FIX)
            useEffect(() => {
                if (auth) {
                    // onAuthStateChanged æœƒåœ¨åˆå§‹åŒ–æˆ–ç™»å…¥/ç™»å‡ºæ™‚ç«‹å³è§¸ç™¼
                    const unsubscribeAuth = auth.onAuthStateChanged(user => {
                        const finalUserId = user ? user.uid : 'N/A';
                        setUserId(finalUserId);
                        // ç¢ºä¿ Auth ç‹€æ…‹ç¢ºå®šå¾Œï¼Œæ‰å°‡ loading è¨­ç‚º false
                        setLoading(false); 
                        console.log("Firebase Auth State Changed. User ID:", finalUserId);
                    });
                    return () => unsubscribeAuth();
                }
            }, [auth]);

            // 3. ç›£è½è³‡æ–™åº« (Projects & Assignees)
            useEffect(() => {
                // å¿…é ˆç­‰å¾… userId ç‹€æ…‹è¢«ç¢ºå®š (å¾ null è®Šæˆ uid æˆ– 'N/A')
                if (!db || userId === null || userId === 'N/A') return; 

                console.log("Starting Firestore Listeners with User ID:", userId);

                // å°ˆæ¡ˆè³‡æ–™ç›£è½
                const unsubscribeProjects = db.collection(PROJECTS_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjects(data);
                    setIsDbConnected(true);
                }, (error) => {
                    console.error("Error fetching projects: ", error);
                    setIsDbConnected(false);
                    showNotification('error', 'ç„¡æ³•è¼‰å…¥å°ˆæ¡ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥ Firebase é€£ç·šæˆ–æ¬Šé™ã€‚');
                });
                
                // è™•ç†äººè³‡æ–™ç›£è½
                const unsubscribeAssignees = db.collection(ASSIGNEES_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAssignees(data);
                }, (error) => {
                    console.error("Error fetching assignees: ", error);
                });

                return () => {
                    unsubscribeProjects();
                    unsubscribeAssignees();
                };
            }, [db, userId, showNotification]);
            
            // ç²å–è™•ç†äººå§“åçš„ Helper
            const getAssigneeName = useCallback((assigneeId) => {
                return assignees.find(a => a.id === assigneeId)?.name || 'æœªæŒ‡æ´¾';
            }, [assignees]);
            
            // æ¨¡æ“¬ç®¡ç†å“¡æ¬Šé™ï¼šåªè¦ç”¨æˆ¶ ID å­˜åœ¨ï¼Œå°±å¯ä»¥æ–°å¢/ç·¨è¼¯ (ç°¡æ˜“æ¨¡æ“¬)
            const canManage = userId && userId !== 'N/A';

            // ä¸»è¦å„€è¡¨æ¿å…§å®¹ (ä½¿ç”¨ Memo å„ªåŒ–åˆ—è¡¨æ¸²æŸ“)
            const DashboardContent = useMemo(() => {
                if (loading) {
                    return (
                        <div className="flex justify-center items-center h-48">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
                            <p className="ml-4 text-lg text-gray-600">è¼‰å…¥å„€è¡¨æ¿ä¸­...</p>
                        </div>
                    );
                }
                
                // é›–ç„¶ Auth ç‹€æ…‹å·²ç¶“ç¢ºå®š (loading=false)ï¼Œä½†å¦‚æœ db ç‚º null æˆ– userId ä»æ˜¯ 'N/A'ï¼Œè¡¨ç¤ºé€£ç·šå¤±æ•—
                if (!db || userId === 'N/A') {
                    return (
                        <div className="flex flex-col items-center justify-center h-48 bg-white border border-red-300 rounded-xl shadow-lg p-6">
                            <AlertTriangle className="w-8 h-8 text-red-500 mb-3" />
                            <p className="text-lg font-semibold text-red-600">ç³»çµ±éŒ¯èª¤æˆ–æœªæˆæ¬Š</p>
                            <p className="text-sm text-gray-500 mt-1">è«‹ç¢ºèª Firebase åˆå§‹åŒ–æ˜¯å¦æˆåŠŸï¼Œä¸¦æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹ã€‚</p>
                        </div>
                    );
                }

                return (
                    <div className="bg-white shadow-xl rounded-xl mt-8 overflow-hidden border border-gray-100">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">å°ˆæ¡ˆåç¨±</th>
                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">ç‹€æ…‹</th>
                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">è™•ç†äºº</th>
                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-100">
                                {projects.length === 0 ? (
                                    <tr>
                                        <td colSpan="4" className="px-6 py-10 whitespace-nowrap text-lg text-gray-400 text-center">
                                            ğŸ‰ æ­å–œï¼Œç›®å‰æ²’æœ‰å¾…è™•ç†çš„å°ˆæ¡ˆï¼
                                            {canManage && <p className="text-sm mt-2">é»æ“Šä¸Šæ–¹ "æ–°å¢å°ˆæ¡ˆ" æŒ‰éˆ•ä¾†é–‹å§‹ä¸€å€‹æ–°ä»»å‹™ã€‚</p>}
                                        </td>
                                    </tr>
                                ) : (
                                    projects.map((project) => (
                                        <tr key={project.id} className="hover:bg-gray-50 transition duration-150">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{project.name}</td>
                                            <td className="px-6 py-4 whitespace-nowrap"><StatusBadge status={project.status} /></td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{getAssigneeName(project.assigneeId)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button
                                                    onClick={() => setAssigneeModalConfig({
                                                        isOpen: true,
                                                        projectId: project.id,
                                                        projectName: project.name,
                                                        currentAssigneeId: project.assigneeId
                                                    })}
                                                    className="inline-flex items-center px-4 py-2 border border-primary-300 rounded-lg shadow-sm text-sm font-medium text-primary-700 bg-primary-50 hover:bg-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition disabled:opacity-50"
                                                    disabled={!db || !canManage} // åªæœ‰ç®¡ç†å“¡å¯ä»¥è½‰äº¤
                                                    title={canManage ? "è½‰äº¤è™•ç†äºº" : "æ‚¨æ²’æœ‰æ¬Šé™è½‰äº¤"}
                                                >
                                                    <Users className="w-4 h-4 mr-2" /> è½‰äº¤è™•ç†äºº
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                );
            }, [projects, loading, db, userId, getAssigneeName, canManage]);

            return (
                <div className="min-h-screen p-4 sm:p-6 lg:p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header and Status */}
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-6 border-b border-gray-200">
                            <h1 className="text-4xl font-extrabold text-gray-900 mb-4 sm:mb-0">
                                å°ˆæ¡ˆé‹ç‡Ÿå„€è¡¨æ¿
                            </h1>
                            <div className="flex items-center space-x-3">
                                {/* æ–°å¢å°ˆæ¡ˆæŒ‰éˆ• - æ¨¡æ“¬ç®¡ç†å“¡åŠŸèƒ½ */}
                                {canManage && (
                                    <button 
                                        onClick={() => setAddProjectModalOpen(true)}
                                        className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition"
                                        disabled={!db}
                                    >
                                        <PlusCircle className="w-5 h-5 mr-2" /> æ–°å¢å°ˆæ¡ˆ
                                    </button>
                                )}

                                <div className="flex items-center space-x-3 bg-white p-3 rounded-xl shadow-md">
                                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${isDbConnected ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        {isDbConnected ? 'ğŸŸ¢ DB é€£ç·šæ­£å¸¸' : 'ğŸ”´ DB é€£ç·šä¸­æ–·'}
                                    </div>
                                    <div className="text-xs text-gray-600 truncate">
                                        ç”¨æˆ¶ ID: <span className="font-mono text-gray-800">{loading ? 'é€£ç·šä¸­...' : userId}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Notification Banner */}
                        {notification.visible && (
                            <div className={`mt-6 p-4 rounded-lg flex items-center shadow-lg ${notification.type === 'success' ? 'bg-green-50 text-green-700 border-l-4 border-green-400' : 'bg-red-50 text-red-700 border-l-4 border-red-400'}`}>
                                {notification.type === 'success' ? <CheckCircle className="w-5 h-5 mr-3" /> : <XCircle className="w-5 h-5 mr-3" />}
                                <p className="text-sm font-medium">{notification.message}</p>
                            </div>
                        )}

                        {/* Project List */}
                        {DashboardContent}
                        
                        {/* Modals */}

                        {/* 1. æ¨¡æ“¬éƒµä»¶é€šçŸ¥æ¨¡æ…‹æ¡† */}
                        <EmailNotificationModal
                            isOpen={emailModalConfig.isOpen}
                            emailContent={emailModalConfig.emailContent}
                            onClose={() => setEmailModalConfig({ ...emailModalConfig, isOpen: false })}
                        />
                        
                        {/* 2. æ›´æ›è™•ç†äººæ¨¡æ…‹æ¡† */}
                        <Modal
                            isOpen={assigneeModalConfig.isOpen}
                            title="æ›´æ›å°ˆæ¡ˆè™•ç†äºº"
                            onClose={() => setAssigneeModalConfig({ ...assigneeModalConfig, isOpen: false })}
                        >
                            {db && assignees.length > 0 && assigneeModalConfig.projectId && (
                                <AssigneeChangeForm
                                    db={db}
                                    projectId={assigneeModalConfig.projectId}
                                    projectName={assigneeModalConfig.projectName}
                                    currentAssigneeId={assigneeModalConfig.currentAssigneeId}
                                    assignees={assignees}
                                    onClose={() => setAssigneeModalConfig({ ...assigneeModalConfig, isOpen: false })}
                                    showNotification={showNotification}
                                    openEmailModal={openEmailModal}
                                />
                            )}
                        </Modal>

                        {/* 3. æ–°å¢å°ˆæ¡ˆæ¨¡æ…‹æ¡† (æ–°å¢åŠŸèƒ½) */}
                        <Modal
                            isOpen={addProjectModalOpen}
                            title="æ–°å¢å°ˆæ¡ˆ (ç®¡ç†å“¡æ“ä½œ)"
                            onClose={() => setAddProjectModalOpen(false)}
                        >
                            {db && (
                                <AddProjectForm
                                    db={db}
                                    assignees={assignees}
                                    onClose={() => setAddProjectModalOpen(false)}
                                    showNotification={showNotification}
                                />
                            )}
                        </Modal>
                    </div>
                </div>
            );
        };

        // ç¢ºä¿ DOM è¼‰å…¥å®Œæˆå¾Œå†æ¸²æŸ“
        window.onload = () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            } else {
                console.error("ç„¡æ³•æ‰¾åˆ° #root å…ƒç´ ");
            }
        };
    </script>
</body>
</html>

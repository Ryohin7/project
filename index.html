<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案儀表板 - 用戶自主註冊與版本號</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 設定 Tailwind CSS 配置，使用 Inter 字體和標準色調 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-500': '#4f46e5', // Indigo-600
                        'primary-600': '#4338ca', // Indigo-700
                        'teal-500': '#14b8a6', // For Admin features
                        'teal-600': '#0d9488',
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs (使用兼容版本 9.23.0) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // -------------------------------------------------------------------
        // 1. 環境變數設定與版本號
        // -------------------------------------------------------------------
        const APP_VERSION = '1.1.0'; // 新增應用程式版本號
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 確保 Firebase 的日誌級別被設定為 Debug (用於開發和偵錯)
        if (typeof firebase !== 'undefined' && firebase.firestore) {
            firebase.firestore.setLogLevel('debug');
        }

        const { useState, useEffect, useCallback, useMemo } = React;
        const rootElement = document.getElementById('root');
        
        // -------------------------------------------------------------------
        // 2. 共用組件 (Shared Components)
        // ---------------------------------------------------

        // Lucide Icon Component Helper 
        const Icon = ({ name, size = 20, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);

            useEffect(() => {
                if (typeof lucide !== 'undefined' && lucide.icons && lucide.icons[name]) {
                    try {
                        // 使用 toSvg 方法從 lucide 全局物件取得 SVG 字串
                        const iconSvg = lucide.icons[name].toSvg({ class: className, width: size, height: size });
                        setSvgHtml(iconSvg);
                    } catch (error) {
                        // 如果 toSvg 失敗，可能是 API 版本問題，此時應檢查 console
                        console.error(`Error generating SVG for icon ${name} (lucide version issue?):`, error);
                        setSvgHtml(null); 
                    }
                }
            }, [name, size, className]);
            
            if (!svgHtml) return null;
            return <span className={className} dangerouslySetInnerHTML={{ __html: svgHtml }} />;
        };

        const LoadingSpinner = ({ message = "載入中，請稍候..." }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4">
                <Icon name="Loader" className="animate-spin text-primary-500 mb-3" size={32} />
                <p className="text-gray-600 font-medium">{message}</p>
            </div>
        );

        const Notification = ({ message, type, onClose }) => {
            const baseClasses = "fixed bottom-5 right-5 p-4 rounded-lg shadow-xl z-50 transform transition-all duration-300 ease-out";
            const typeClasses = {
                success: "bg-green-500 text-white",
                error: "bg-red-500 text-white",
                info: "bg-blue-500 text-white",
            }[type] || "bg-gray-700 text-white";

            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`${baseClasses} ${typeClasses}`}>
                    <div className="flex items-center justify-between">
                        <span className="font-semibold">{message}</span>
                        <button onClick={onClose} className="ml-4 opacity-75 hover:opacity-100">
                            <Icon name="X" size={18} />
                        </button>
                    </div>
                </div>
            );
        };
        
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            
            return (
                <div 
                    className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-40 transition-opacity duration-300"
                    onClick={onClose}
                >
                    <div 
                        className="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 ease-out"
                        onClick={(e) => e.stopPropagation()} // 防止點擊 Modal 內容時關閉
                    >
                        <div className="flex justify-between items-center p-5 border-b border-gray-100">
                            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
                                <Icon name="X" size={24} />
                            </button>
                        </div>
                        <div className="p-5">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // -------------------------------------------------------------------
        // 3. 核心鉤子 (Core Hook: useFirebase) - 處理初始化、認證、資料同步
        // -------------------------------------------------------------------
        
        const useFirebase = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userRole, setUserRole] = useState('guest'); // guest, user, admin
            const [userDept, setUserDept] = useState('未註冊'); // 預設值調整為 '未註冊'
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [projects, setProjects] = useState([]);
            const [assignees, setAssignees] = useState([]); // All users in the system
            const [logs, setLogs] = useState([]); // System logs

            const getPublicPath = useCallback((collectionName) => 
                `artifacts/${appId}/public/data/${collectionName}`, [appId]);

            const logAction = useCallback(async (action, projectId = null) => {
                if (!db || !userId || userRole === 'guest') return; // 訪客不記錄日誌
                try {
                    // 使用 compat API 的 collection 和 add 方法
                    await db.collection(getPublicPath('systemLogs')).add({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: userId,
                        userName: assignees.find(u => u.uid === userId)?.name || 'Unknown User',
                        action: action,
                        projectId: projectId,
                        role: userRole
                    });
                } catch (e) {
                    console.error("Failed to log action:", e);
                }
            }, [db, userId, userRole, assignees, getPublicPath]);
            
            useEffect(() => {
                let unsubscribeAuth = () => {};
                let unsubscribeUsers = () => {};
                let unsubscribeProjects = () => {};
                let unsubscribeLogs = () => {};
                
                const initFirebase = async () => {
                    try {
                        console.log("1. Starting Firebase initialization...");
                        
                        // 使用 compat API 進行初始化
                        const app = firebase.initializeApp(firebaseConfig);
                        const authInstance = app.auth();
                        const dbInstance = app.firestore();

                        setAuth(authInstance);
                        setDb(dbInstance);

                        // --- 認證流程 ---
                        console.log(`2. Attempting sign-in. Token exists: ${!!initialAuthToken}`);

                        if (authInstance.currentUser) {
                            console.log("User already signed in:", authInstance.currentUser.uid);
                        } else if (initialAuthToken) {
                            await authInstance.signInWithCustomToken(initialAuthToken);
                        } else {
                            // 即使是匿名登入，也會生成一個 uid
                            await authInstance.signInAnonymously();
                        }

                        // --- 狀態變更監聽器 ---
                        unsubscribeAuth = authInstance.onAuthStateChanged(async (user) => {
                            if (user) {
                                const currentUserId = user.uid;
                                setUserId(currentUserId);
                                console.log("3. Auth state changed. User ID:", currentUserId);

                                // 4. 檢查使用者資料 (Public Collection)
                                let role = 'guest';
                                let department = '未註冊';
                                try {
                                    const userRef = dbInstance.collection(getPublicPath('users')).doc(currentUserId);
                                    
                                    const userDoc = await userRef.get();
                                    
                                    if (userDoc.exists) {
                                        // 用戶已註冊
                                        const userData = userDoc.data();
                                        role = userData.role || 'user';
                                        department = userData.department || '未設定';

                                        // 更新登入時間
                                        await userRef.update({ 
                                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                        console.log(`4. User data loaded. Role: ${role}, Dept: ${department}`);
                                    } else {
                                        // 首次登入或未註冊：保持 role 為 guest，強制進入註冊流程
                                        role = 'guest';
                                        department = '未註冊';
                                        console.log("4. User document NOT found. Setting role to 'guest' for self-registration.");
                                    }
                                    
                                    setUserRole(role);
                                    setUserDept(department); // 設定部門狀態
                                    
                                } catch (e) {
                                    console.error("CRITICAL ERROR: Failed to check user data in Firestore. Check Security Rules:", e);
                                    setUserRole('guest'); 
                                    setUserDept('錯誤'); 
                                }

                                // 5. 設定 Firestore 即時監聽器 (只有在 auth 成功後才設定)
                                
                                // 監聽所有使用者 (Assignees)
                                unsubscribeUsers = dbInstance.collection(getPublicPath('users')).onSnapshot(snapshot => {
                                    const usersData = snapshot.docs.map(doc => doc.data());
                                    setAssignees(usersData);
                                }, error => {
                                    console.error("Error fetching users (Assignees):", error);
                                });

                                // 監聽專案資料 (Public Collection)
                                unsubscribeProjects = dbInstance.collection(getPublicPath('projects'))
                                    .orderBy('createdAt', 'desc')
                                    .onSnapshot(snapshot => {
                                        const projectsData = snapshot.docs.map(doc => ({
                                            id: doc.id,
                                            ...doc.data()
                                        }));
                                        setProjects(projectsData);
                                    }, error => {
                                        console.error("Error fetching projects:", error);
                                    });

                                // 監聽系統日誌 (Public Collection)
                                unsubscribeLogs = dbInstance.collection(getPublicPath('systemLogs'))
                                    .orderBy('timestamp', 'desc')
                                    .limit(50) // 只顯示最新的 50 條日誌
                                    .onSnapshot(snapshot => {
                                        const logsData = snapshot.docs.map(doc => ({
                                            id: doc.id,
                                            ...doc.data()
                                        }));
                                        setLogs(logsData);
                                    }, error => {
                                        console.error("Error fetching logs:", error);
                                    });

                                // 註冊線上狀態 (Heartbeat) - 簡化
                                try {
                                    const onlineRef = dbInstance.collection(getPublicPath('onlineUsers')).doc(currentUserId);
                                    await onlineRef.set({ uid: currentUserId, lastActive: firebase.firestore.FieldValue.serverTimestamp() });
                                } catch (e) {
                                     console.error("Failed to set online status:", e);
                                }


                                setIsAuthReady(true);
                                console.log("6. Firebase initialization complete.");

                            } else {
                                console.log("User signed out or failed to authenticate.");
                                setUserId(null);
                                setUserRole('guest');
                                setUserDept('未註冊');
                                setIsAuthReady(true); 
                            }
                        });

                    } catch (error) {
                        console.error("CRITICAL ERROR during Firebase init or auth:", error);
                        setIsAuthReady(true); 
                    }
                };

                initFirebase();

                // 清理函數：組件卸載時移除所有監聽器
                return () => {
                    unsubscribeAuth();
                    unsubscribeUsers();
                    unsubscribeProjects();
                    unsubscribeLogs();
                };
            }, [appId, initialAuthToken, getPublicPath]);

            const canManage = userRole === 'admin';

            return {
                db,
                auth,
                userId,
                userRole,
                userDept,
                canManage,
                isAuthReady,
                projects,
                assignees,
                logs,
                logAction,
                getPublicPath,
            };
        };

        // -------------------------------------------------------------------
        // 4. 專案看板組件 (Project Dashboard Components)
        // -------------------------------------------------------------------
        
        // 狀態標籤組件
        const StatusBadge = ({ status }) => {
            const statusMap = {
                'Pending': 'bg-yellow-100 text-yellow-800',
                'InProgress': 'bg-blue-100 text-blue-800',
                'Completed': 'bg-green-100 text-green-800',
                'OnHold': 'bg-gray-200 text-gray-700',
                'admin': 'bg-teal-100 text-teal-800', // for admin panel
                'user': 'bg-indigo-100 text-indigo-800', // for admin panel
                'guest': 'bg-red-100 text-red-800', // for admin panel
                '未設定': 'bg-gray-100 text-gray-600',
                '未註冊': 'bg-red-100 text-red-800',
            };
            const textMap = {
                'Pending': '待處理',
                'InProgress': '進行中',
                'Completed': '已完成',
                'OnHold': '暫停',
                'admin': '管理員',
                'user': '一般用戶',
                'guest': '訪客',
                '未註冊': '未註冊',
            };
            const classes = statusMap[status] || 'bg-gray-100 text-gray-600';
            const displayStatus = textMap[status] || status;
            return (
                <span className={`inline-flex items-center px-3 py-1 text-xs font-medium rounded-full ${classes}`}>
                    {displayStatus}
                </span>
            );
        };

        // 專案卡片組件
        const ProjectCard = ({ project, assignees, onEdit, userId }) => {
            const assignee = assignees.find(a => a.uid === project.assigneeId);
            const isAssigned = project.assigneeId === userId;
            const titleClasses = isAssigned ? "text-primary-600 font-bold" : "text-gray-800 font-semibold";
            
            return (
                <div className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-5 flex flex-col justify-between border border-gray-100">
                    <div>
                        <div className="flex justify-between items-start mb-3">
                            <h4 className={`text-lg ${titleClasses} truncate pr-2`} title={project.name}>{project.name}</h4>
                            <StatusBadge status={project.status} />
                        </div>
                        <p className="text-sm text-gray-600 mb-4 line-clamp-3">{project.description || "無描述"}</p>
                    </div>
                    <div>
                        <div className="flex justify-between items-center text-sm text-gray-500 mt-2 border-t pt-3">
                            <div className="flex items-center">
                                <Icon name="User" size={16} className="mr-1 text-gray-400" />
                                <span className="truncate" title={assignee?.name}>
                                    {assignee ? (isAssigned ? '我' : assignee.name) : '未指派'}
                                    {assignee?.department && ` (${assignee.department})`}
                                </span>
                            </div>
                            <div className="flex items-center">
                                <Icon name="Calendar" size={16} className="mr-1 text-gray-400" />
                                <span>
                                    {project.dueDate ? new Date(project.dueDate).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }) : 'N/A'}
                                </span>
                            </div>
                        </div>
                        <button 
                            onClick={() => onEdit(project)}
                            className="mt-4 w-full text-center text-sm font-medium py-2 rounded-lg text-primary-500 hover:bg-primary-50 transition-colors"
                        >
                            查看詳情 / 編輯
                        </button>
                    </div>
                </div>
            );
        };

        // 編輯/新增專案模態框 (簡化版)
        const ProjectForm = ({ project, assignees, onSubmit, onClose, canManage }) => {
            const isEditMode = !!project; // 修正：從 prop 判斷是否為編輯模式
            const initialDate = isEditMode && project.dueDate ? project.dueDate : new Date().toISOString().substring(0, 10);
            const [formData, setFormData] = useState(project || { name: '', description: '', status: 'Pending', assigneeId: '', dueDate: initialDate });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };

            const statusOptions = ['Pending', 'InProgress', 'Completed', 'OnHold'];

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <input type="text" name="name" value={formData.name} onChange={handleChange} required placeholder="專案名稱"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" />
                    
                    <textarea name="description" value={formData.description} onChange={handleChange} rows="3" placeholder="專案描述"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150"></textarea>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <select name="status" value={formData.status} onChange={handleChange} required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150">
                            {statusOptions.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                        
                        <input type="date" name="dueDate" value={formData.dueDate} onChange={handleChange} required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" />
                    </div>

                    <select name="assigneeId" value={formData.assigneeId} onChange={handleChange}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150"
                        disabled={!canManage && isEditMode} // 編輯模式下，若非管理員，不允許修改指派人
                    >
                        <option value="">未指派</option>
                        {assignees
                            .filter(a => a.role !== 'guest') // 只顯示已註冊的用戶
                            .map(a => (
                            <option key={a.uid} value={a.uid}>{a.name} ({a.department || 'N/A'})</option>
                        ))}
                    </select>
                    {!canManage && isEditMode && (
                        <p className="text-xs text-gray-500 mt-1">只有管理員才能修改指派人員。</p>
                    )}

                    <div className="flex justify-end space-x-3 mt-5">
                        <button type="button" onClick={onClose}
                            className="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                            取消
                        </button>
                        <button type="submit"
                            className="px-4 py-2 bg-primary-500 text-white font-semibold rounded-lg shadow-md hover:bg-primary-600 transition-colors">
                            <div className="flex items-center justify-center">
                                {/* 修正：使用 isEditMode 變數 */}
                                <Icon name={isEditMode ? 'Save' : 'Plus'} size={18} className="mr-1" />
                                <span>{isEditMode ? '更新專案' : '新增專案'}</span>
                            </div>
                        </button>
                    </div>
                </form>
            );
        };
        
        // 新增用戶註冊表單組件 (供管理員預先註冊或設定權限)
        const UserRegistrationForm = ({ assignees, getPublicPath, db, showNotification, logAction, onClose }) => {
            const [formData, setFormData] = useState({ name: '', employeeId: '', department: '企劃' });
            // 根據您的要求設定部門列表，並加入一個 'Admin' 選項用於快速賦予管理員權限
            const departments = ['企劃', '設計', '商品', '營業', 'Admin'];

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.name || !formData.employeeId) {
                    return showNotification("姓名和員編為必填項。", "error");
                }

                try {
                    // 1. 檢查員編是否重複
                    const employeeIdExists = assignees.some(a => a.employeeId === formData.employeeId);
                    if (employeeIdExists) {
                        return showNotification(`員編 ${formData.employeeId} 已存在，請使用其他員編。`, "error");
                    }
                    
                    // 2. 創建新的用戶 ID (使用隨機 UUID 作為 Firestore Doc ID，以預先註冊)
                    const newUid = crypto.randomUUID();
                    const userRef = db.collection(getPublicPath('users')).doc(newUid);

                    const roleToAssign = formData.department === 'Admin' ? 'admin' : 'user';

                    // 3. 寫入資料
                    await userRef.set({
                        uid: newUid,
                        name: formData.name,
                        employeeId: formData.employeeId,
                        department: formData.department,
                        role: roleToAssign, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });

                    logAction(`[Admin] 預先註冊了新用戶: ${formData.name} (${formData.employeeId})`, newUid);
                    showNotification(`用戶 ${formData.name} (角色: ${roleToAssign}) 註冊成功！`, "success");
                    
                    // 重設表單並關閉
                    setFormData({ name: '', employeeId: '', department: '企劃' });
                    // 不關閉 Modal 讓管理員可以連續新增
                    // onClose(); 
                    
                } catch (e) {
                    console.error("User registration failed:", e);
                    showNotification("用戶註冊失敗，請檢查權限設定或網路連接。", "error");
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h4 className="text-lg font-semibold text-gray-700 border-b pb-2">新增企業內部員工資料</h4>
                    
                    <input type="text" name="name" value={formData.name} onChange={handleChange} required placeholder="姓名"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150" />
                    
                    <input type="text" name="employeeId" value={formData.employeeId} onChange={handleChange} required placeholder="員編 (唯一識別碼)"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150" />
                    
                    <select name="department" value={formData.department} onChange={handleChange} required
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                        {departments.map(d => <option key={d} value={d}>{d}</option>)}
                    </select>
                    
                    <div className="pt-2">
                        <p className="text-xs text-gray-500 mb-3">
                            **說明:** 此操作在系統中創建用戶資料，賦予其 UID 並設定初始權限。
                        </p>
                        <button type="submit"
                            className="w-full px-4 py-3 bg-teal-500 text-white font-semibold rounded-lg shadow-lg hover:bg-teal-600 transition-colors flex items-center justify-center">
                            <Icon name="UserPlus" size={20} className="mr-2" /> 確定新增用戶
                        </button>
                    </div>
                </form>
            );
        };
        
        // 管理員面板模態框 (Admin Management Modal) - 整合註冊功能
        const AdminManagementModal = ({ assignees, logs, db, getPublicPath, logAction, showNotification, onClose }) => {
            const [activeTab, setActiveTab] = useState('users');

            // 角色映射
            const roleMap = {
                'admin': '管理員',
                'user': '一般用戶',
                'guest': '訪客'
            };

            const LogItem = ({ log }) => (
                <div className="p-3 border-b border-gray-100 text-sm">
                    <span className="font-semibold text-gray-700">{log.userName}</span> 
                    <span className="text-gray-500"> ({roleMap[log.role] || log.role}) </span>
                    <span className="text-primary-500 ml-1">{log.action}</span>
                    {log.projectId && <span className="text-xs ml-2 px-2 py-0.5 bg-gray-100 rounded">專案ID: {log.projectId.substring(0, 4)}...</span>}
                    <span className="block text-xs text-gray-400 mt-0.5">
                        {log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleDateString('zh-TW', { hour: '2-digit', minute: '2-digit', month: '2-digit', day: '2-digit' }) : 'N/A'}
                    </span>
                </div>
            );
            
            // 用戶清單顯示組件
            const UserList = ({ users }) => (
                <div className="space-y-3 max-h-80 overflow-y-auto">
                    {users.map(user => (
                        <div key={user.uid} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p className="font-semibold text-gray-800">{user.name} 
                                    {user.employeeId && <span className="text-xs ml-2 text-primary-500">({user.employeeId})</span>}
                                </p>
                                <p className="text-xs text-gray-500 truncate" title={user.uid}>UID: {user.uid.substring(0, 8)}...</p>
                                <p className="text-xs text-gray-600 mt-1">部門: {user.department || 'N/A'}</p>
                            </div>
                            <StatusBadge status={user.role || '未設定'} />
                        </div>
                    ))}
                </div>
            );

            return (
                <Modal isOpen={true} onClose={onClose} title="管理員面板">
                    <div className="border-b mb-4">
                        <nav className="flex space-x-4">
                            <button 
                                onClick={() => setActiveTab('users')} 
                                className={`py-2 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'users' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                用戶清單 ({assignees.length})
                            </button>
                            <button 
                                onClick={() => setActiveTab('register')} 
                                className={`py-2 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'register' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                管理員註冊用戶
                            </button>
                            <button 
                                onClick={() => setActiveTab('logs')} 
                                className={`py-2 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'logs' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                系統日誌 ({logs.length})
                            </button>
                        </nav>
                    </div>

                    {activeTab === 'users' && <UserList users={assignees} />}

                    {activeTab === 'register' && (
                        <UserRegistrationForm 
                            assignees={assignees} 
                            db={db} 
                            getPublicPath={getPublicPath}
                            showNotification={showNotification}
                            logAction={logAction}
                            onClose={onClose}
                        />
                    )}

                    {activeTab === 'logs' && (
                        <div className="space-y-1 max-h-80 overflow-y-auto bg-white rounded-lg border">
                            {logs.map(log => <LogItem key={log.id} log={log} />)}
                        </div>
                    )}
                </Modal>
            );
        };
        
        // 新增：用戶自主註冊表單組件
        const SelfRegistrationForm = ({ userId, db, getPublicPath, assignees, showNotification }) => {
            const [formData, setFormData] = useState({ name: '', employeeId: '', department: '企劃' });
            const [isLoading, setIsLoading] = useState(false);
            const departments = ['企劃', '設計', '商品', '營業'];

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.name || !formData.employeeId) {
                    return showNotification("姓名和員編為必填項。", "error");
                }
                
                setIsLoading(true);

                try {
                    // 1. 檢查員編是否重複
                    const employeeIdExists = assignees.some(a => a.employeeId === formData.employeeId);
                    if (employeeIdExists) {
                        setIsLoading(false);
                        return showNotification(`員編 ${formData.employeeId} 已存在，請聯繫管理員。`, "error");
                    }
                    
                    // 2. 更新當前用戶的 Firestore 文件
                    const userRef = db.collection(getPublicPath('users')).doc(userId);
                    
                    await userRef.set({
                        uid: userId,
                        name: formData.name,
                        employeeId: formData.employeeId, // 員編作為登入的唯一識別碼
                        department: formData.department,
                        role: 'user', // 自主註冊的用戶預設為 'user'
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    });

                    // 註冊成功後，useFirebase 鉤子會自動偵測到 role 變為 'user' 並重新渲染 App
                    showNotification(`註冊成功！歡迎 ${formData.name}。`, "success");
                    
                } catch (e) {
                    console.error("Self-registration failed:", e);
                    showNotification("註冊失敗，請檢查網路或聯繫管理員。", "error");
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="max-w-md mx-auto p-8 bg-white rounded-xl shadow-2xl mt-10">
                    <div className="text-center mb-6">
                        <Icon name="UserCircle" size={48} className="text-primary-500 mx-auto mb-3" />
                        <h2 className="text-2xl font-bold text-gray-800">用戶自主註冊</h2>
                        <p className="text-sm text-gray-500 mt-1">請填寫您的企業資料以開始使用儀表板。</p>
                        <p className="text-xs text-gray-400 mt-1">您的暫時 ID: {userId.substring(0, 8)}...</p>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input type="text" name="name" value={formData.name} onChange={handleChange} required placeholder="姓名"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" />
                        
                        <input type="text" name="employeeId" value={formData.employeeId} onChange={handleChange} required placeholder="員編 (登入的唯一識別碼)"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" />
                        
                        <select name="department" value={formData.department} onChange={handleChange} required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150">
                            {departments.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                        
                        <button type="submit" disabled={isLoading}
                            className={`w-full px-4 py-3 text-white font-semibold rounded-lg shadow-md transition-colors flex items-center justify-center ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-primary-500 hover:bg-primary-600'}`}>
                            {isLoading ? (
                                <>
                                    <Icon name="Loader" size={20} className="animate-spin mr-2" />
                                    <span>正在註冊...</span>
                                </>
                            ) : (
                                <>
                                    <Icon name="CheckCircle" size={20} className="mr-2" />
                                    <span>完成註冊並進入儀表板</span>
                                </>
                            )}
                        </button>
                    </form>
                </div>
            );
        };


        // 5. App Component - 主應用程式
        const App = () => {
            const { 
                db, 
                userId, 
                userRole, 
                userDept,
                canManage, 
                isAuthReady, 
                projects, 
                assignees, 
                logs, 
                logAction,
                getPublicPath 
            } = useFirebase();
            
            const [notification, setNotification] = useState(null);
            const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [adminManagementModalOpen, setAdminManagementModalOpen] = useState(false);

            const showNotification = useCallback((message, type = 'info') => {
                setNotification({ message, type });
            }, []);

            // 處理專案新增/編輯的提交
            const handleProjectSubmit = async (formData) => {
                if (!db || !userId) return showNotification("應用程式未準備好，請稍候。", "error");

                try {
                    // 使用 compat API 的 collection 和 doc
                    const projectsCollection = db.collection(getPublicPath('projects'));
                    
                    if (editingProject) {
                        // 編輯現有專案
                        await projectsCollection.doc(editingProject.id).update(formData);
                        logAction(`更新了專案: ${formData.name}`, editingProject.id);
                        showNotification("專案更新成功！", "success");
                    } else {
                        // 新增專案
                        const newDoc = await projectsCollection.add({
                            ...formData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: userId,
                        });
                        logAction(`新增了專案: ${formData.name}`, newDoc.id);
                        showNotification("專案新增成功！", "success");
                    }
                    
                    setIsProjectModalOpen(false);
                    setEditingProject(null);
                } catch (e) {
                    console.error("Project submission failed:", e);
                    showNotification("操作失敗，請檢查日誌，可能是權限問題。", "error");
                }
            };
            
            // 點擊編輯
            const handleEditProject = (project) => {
                setEditingProject({ 
                    ...project, 
                    // 確保日期格式為 YYYY-MM-DD
                    dueDate: project.dueDate.substring(0, 10) 
                });
                setIsProjectModalOpen(true);
            };

            const handleOpenAdd = () => {
                setEditingProject(null);
                setIsProjectModalOpen(true);
            }


            // 身份檢查
            if (!isAuthReady) {
                return <LoadingSpinner message="正在初始化 Firebase 與身份驗證..." />;
            }
            
            // 如果 isAuthReady 為 true 但沒有 userId，這意味著匿名/Token 登入可能失敗
            if (!userId) {
                 return (
                    <div className="p-8 max-w-4xl mx-auto text-center">
                        <h1 className="text-3xl font-bold text-red-600 mb-4">無法識別用戶身份</h1>
                        <p className="text-gray-600">
                            應用程式無法完成 Firebase 認證。這可能表示您的環境設定有問題，或者 Firebase 服務暫時無法連接。
                        </p>
                        <p className="text-sm text-gray-500 mt-2">請檢查控制台是否有詳細的 Firebase 錯誤訊息。</p>
                        <button 
                            onClick={() => window.location.reload()}
                            className="mt-6 px-6 py-3 bg-primary-500 text-white font-semibold rounded-lg shadow-md hover:bg-primary-600 transition-colors"
                        >
                            重新載入應用程式
                        </button>
                    </div>
                );
            }
            
            // 新增：如果用戶角色是 guest，則強制顯示自主註冊表單
            if (userRole === 'guest') {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                        <SelfRegistrationForm 
                            userId={userId} 
                            db={db}
                            getPublicPath={getPublicPath}
                            assignees={assignees}
                            showNotification={showNotification}
                        />
                         {notification && (
                            <Notification 
                                message={notification.message} 
                                type={notification.type} 
                                onClose={() => setNotification(null)}
                            />
                        )}
                    </div>
                );
            }


            // 根據專案狀態分組
            const groupedProjects = projects.reduce((acc, project) => {
                acc[project.status] = acc[project.status] || [];
                acc[project.status].push(project);
                return acc;
            }, {});

            const statusOrder = ['Pending', 'InProgress', 'Completed', 'OnHold'];

            return (
                <div className="p-4 md:p-8">
                    {/* 通知組件 */}
                    {notification && (
                        <Notification 
                            message={notification.message} 
                            type={notification.type} 
                            onClose={() => setNotification(null)}
                        />
                    )}

                    <div className="max-w-7xl mx-auto">
                        {/* 標題與操作區 */}
                        <header className="flex justify-between items-center mb-6 border-b pb-4">
                            <h1 className="text-3xl font-extrabold text-gray-900">
                                專案儀表板 
                                <span className="text-sm font-medium text-gray-500 ml-2">
                                    （角色: {userRole}，部門: {userDept}）
                                </span>
                            </h1>
                            <div className="flex items-center space-x-3">
                                <span className="text-xs text-gray-500 mr-4">v{APP_VERSION}</span> {/* 顯示版本號 */}
                                {canManage && (
                                    <button 
                                        onClick={() => setAdminManagementModalOpen(true)}
                                        className="flex items-center px-4 py-2 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600 transition-colors"
                                    >
                                        <Icon name="Settings" size={20} className="mr-2" /> 管理面板
                                    </button>
                                )}
                                <button 
                                    onClick={handleOpenAdd}
                                    className="flex items-center px-4 py-2 bg-primary-500 text-white font-semibold rounded-lg shadow-md hover:bg-primary-600 transition-colors"
                                >
                                    <Icon name="PlusCircle" size={20} className="mr-2" /> 新增專案
                                </button>
                            </div>
                        </header>

                        {/* 專案看板 */}
                        <main className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            {statusOrder.map(status => (
                                <div key={status} className="p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <h3 className="text-lg font-bold mb-4 flex items-center text-gray-700">
                                        <StatusBadge status={status} />
                                        <span className="ml-2">
                                            {statusOrder.indexOf(status) === 0 ? '待處理' : 
                                             statusOrder.indexOf(status) === 1 ? '進行中' : 
                                             statusOrder.indexOf(status) === 2 ? '已完成' : '暫停'}
                                        </span>
                                        <span className="ml-2 text-sm font-medium text-gray-400">({groupedProjects[status]?.length || 0})</span>
                                    </h3>
                                    <div className="space-y-4 min-h-[100px]">
                                        {groupedProjects[status]?.map(project => (
                                            <ProjectCard 
                                                key={project.id} 
                                                project={project} 
                                                assignees={assignees} 
                                                onEdit={handleEditProject} 
                                                userId={userId} 
                                            />
                                        ))}
                                        {(!groupedProjects[status] || groupedProjects[status].length === 0) && (
                                            <p className="text-sm text-gray-400 text-center py-6 border border-dashed rounded-lg">此狀態下沒有專案。</p>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </main>
                        
                        {/* 模態框：新增/編輯專案 */}
                        <Modal 
                            isOpen={isProjectModalOpen} 
                            onClose={() => setIsProjectModalOpen(false)} 
                            title={editingProject ? '編輯專案' : '新增專案'}
                        >
                            <ProjectForm
                                project={editingProject}
                                assignees={assignees}
                                onSubmit={handleProjectSubmit}
                                onClose={() => setIsProjectModalOpen(false)}
                                canManage={canManage} // 傳遞管理權限
                            />
                        </Modal>
                        
                        {/* 模態框：管理員面板 */}
                        {canManage && db && adminManagementModalOpen && ( 
                            <AdminManagementModal
                                assignees={assignees}
                                logs={logs}
                                db={db}
                                getPublicPath={getPublicPath}
                                logAction={logAction}
                                showNotification={showNotification}
                                onClose={() => setAdminManagementModalOpen(false)}
                            />
                        )}

                    </div>
                </div>
            );
        };

        // 確保 DOM 載入完成後再渲染
        window.onload = () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            } else {
                console.error("無法找到 #root 元素");
            }
        };
    </script>
</body>
</html>

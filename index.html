<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- React & ReactDOM (指定版本 18.2.0 以確保穩定性) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body, #root {
            height: 100vh;
            margin: 0;
            background-color: #f7f8fa;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ----------------------------------------------------------------------
        // 0. ICONS (內建 SVG 以移除 lucide-react 外部依賴)
        // ----------------------------------------------------------------------
        const IconWrapper = ({ children, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const RefreshCw = (props) => (
            <IconWrapper {...props}>
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
                <path d="M21 3v5h-5" />
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
                <path d="M8 16H3v5" />
            </IconWrapper>
        );

        const Users = (props) => (
            <IconWrapper {...props}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </IconWrapper>
        );

        const Send = (props) => (
            <IconWrapper {...props}>
                <line x1="22" y1="2" x2="11" y2="13" />
                <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </IconWrapper>
        );

        const CheckCircle = (props) => (
            <IconWrapper {...props}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </IconWrapper>
        );

        const XCircle = (props) => (
            <IconWrapper {...props}>
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
            </IconWrapper>
        );

        // ----------------------------------------------------------------------
        // 1. SETUP & CONSTANTS
        // ----------------------------------------------------------------------
        
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // ** 修正: 獲取 Canvas 環境的 App ID **
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ** 修正: 使用符合安全規則的完整路徑 **
        // 規則: /artifacts/{appId}/public/data/{collectionName}
        const PROJECTS_PATH = `artifacts/${appId}/public/data/projects`;
        const ASSIGNEES_PATH = `artifacts/${appId}/public/data/assignees`;
        const CONFIG_PATH = `artifacts/${appId}/public/data/config`;
        
        // 提供的 Firebase 設定作為 fallback (若 Canvas 環境未提供則使用此配置)
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyCMiLg3coEoLeVtLmfEK_zlAHsHZ-yZfP0",
            authDomain: "project-407d1.firebaseapp.com",
            projectId: "project-407d1",
            storageBucket: "project-407d1.firebasestorage.app",
            messagingSenderId: "524548363140",
            appId: "1:524548363140:web:7b7dedc2a70faf5790c3d1",
            measurementId: "G-QXYBX3MFXE"
        };
        
        // 優先使用 Canvas 環境提供的設定 (__firebase_config)，否則使用預設配置
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : defaultFirebaseConfig;

        let app;
        let db;
        let authInstance;
        
        const initFirebase = async () => {
            try {
                if (app) {
                    return { db, authInstance };
                }
                
                app = firebase.initializeApp(firebaseConfig);
                authInstance = firebase.auth(app);
                db = firebase.firestore(app);
                
                console.log("Firebase 應用程式初始化成功。");

                // 處理 Canvas Custom Token 或匿名登入
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (token) {
                    await authInstance.signInWithCustomToken(token);
                    console.log("Signed in with Custom Token.");
                } else {
                    await authInstance.signInAnonymously();
                    console.log("Signed in anonymously (Fallback).");
                }
                
                return { db, authInstance };
            } catch (error) {
                console.error("Firebase 初始化或登入失敗:", error);
                return { db: null, authInstance: null };
            }
        };

        // ----------------------------------------------------------------------
        // 3. UI COMPONENTS
        // ----------------------------------------------------------------------
        
        const Modal = ({ isOpen, title, children, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
                        <div className="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition">
                                <XCircle className="w-6 h-6" />
                            </button>
                        </div>
                        <div>
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const AssigneeChangeForm = ({ db, projectId, projectName, currentAssigneeId, assignees, onClose, showNotification, openEmailModal }) => {
            const [selectedAssigneeId, setSelectedAssigneeId] = useState(currentAssigneeId);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                
                try {
                    // 使用 collection() 和 doc() 方法
                    const projectRef = db.collection(PROJECTS_PATH).doc(projectId);
                    await projectRef.update({
                        assigneeId: selectedAssigneeId,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });

                    const newAssignee = assignees.find(a => a.id === selectedAssigneeId) || { name: '未知' };
                    const oldAssignee = assignees.find(a => a.id === currentAssigneeId) || { name: '未知' };

                    showNotification('success', `成功將專案 [${projectName}] 的處理人從 ${oldAssignee.name} 更換為 ${newAssignee.name}。`);
                    
                    const newAssigneeEmail = newAssignee.email || '';
                    openEmailModal(
                        newAssigneeEmail, 
                        `【專案轉移通知】您現在是專案 [${projectName}] 的處理人`,
                        `您好 ${newAssignee.name},\n\n專案 [${projectName}] 已於 ${new Date().toLocaleString()} 轉交給您處理。\n\n原處理人：${oldAssignee.name}\n\n請登入儀表板查看詳情並開始處理。\n\n謝謝!`
                    );

                    onClose();
                } catch (error) {
                    console.error("更新處理人失敗:", error);
                    showNotification('error', '更新處理人失敗。請查看 Console 獲取詳細資訊。');
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            const currentAssignee = assignees.find(a => a.id === currentAssigneeId)?.name || 'N/A';
            
            return (
                <form onSubmit={handleSubmit}>
                    <p className="mb-4 text-sm text-gray-600">
                        目前專案 <strong>{projectName}</strong> 的處理人是: <strong>{currentAssignee}</strong>
                    </p>
                    <div className="mb-4">
                        <label htmlFor="assignee-select" className="block text-sm font-medium text-gray-700 mb-2">選擇新的處理人</label>
                        <select
                            id="assignee-select"
                            value={selectedAssigneeId}
                            onChange={(e) => setSelectedAssigneeId(e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            required
                            disabled={isSubmitting}
                        >
                            <option value="">-- 請選擇 --</option>
                            {assignees.map((a) => (
                                <option key={a.id} value={a.id}>{a.name} ({a.email})</option>
                            ))}
                        </select>
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button 
                            type="button" 
                            onClick={onClose} 
                            className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition"
                            disabled={isSubmitting}
                        >
                            取消
                        </button>
                        <button 
                            type="submit" 
                            className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition disabled:bg-blue-400"
                            disabled={isSubmitting || selectedAssigneeId === currentAssigneeId}
                        >
                            {isSubmitting ? '更換中...' : '確認更換'}
                        </button>
                    </div>
                </form>
            );
        };

        // ----------------------------------------------------------------------
        // 4. MAIN APPLICATION COMPONENT
        // ----------------------------------------------------------------------

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [projects, setProjects] = useState([]);
            const [assignees, setAssignees] = useState([]);
            const [userId, setUserId] = useState('N/A');
            const [isAdmin, setIsAdmin] = useState(false);
            const [isDbConnected, setIsDbConnected] = useState(true);
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState({ visible: false, type: 'success', message: '' });

            const [notificationModalConfig, setNotificationModalConfig] = useState({
                isOpen: false,
                emailContent: { to: '', subject: '', body: '' }
            });
            const [assigneeModalConfig, setAssigneeModalConfig] = useState({
                isOpen: false,
                projectId: null,
                projectName: '',
                currentAssigneeId: null,
            });

            const showNotification = useCallback((type, message) => {
                setNotification({ visible: true, type, message });
                setTimeout(() => {
                    setNotification({ visible: false, type, message: '' });
                }, 4000);
            }, []);

            const openEmailModal = (to, subject, body) => {
                setNotificationModalConfig({
                    isOpen: true,
                    emailContent: { to, subject, body }
                });
            };

            // 初始化 Firebase
            useEffect(() => {
                initFirebase().then(({ db: initializedDb, auth: initializedAuth }) => {
                    setDb(initializedDb);
                    setAuth(initializedAuth);
                    setLoading(false);
                });
            }, []);
            
            // 監聽使用者
            useEffect(() => {
                if (auth) {
                    const unsubscribeAuth = auth.onAuthStateChanged(user => {
                        if (user) {
                            setUserId(user.uid);
                            // 在這裡添加您的管理員 UID 檢查邏輯
                            setIsAdmin(true); 
                        } else {
                            setUserId('N/A');
                            setIsAdmin(false);
                        }
                    });
                    return () => unsubscribeAuth();
                }
            }, [auth]);

            // 監聽資料
            useEffect(() => {
                if (!db) return;

                // 修正：確保使用正確的路徑常數
                const unsubscribeProjects = db.collection(PROJECTS_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjects(data);
                    setIsDbConnected(true);
                }, (error) => {
                    console.error("Error fetching projects: ", error);
                    setIsDbConnected(false);
                    showNotification('error', '無法載入專案資料，請檢查 Firebase 連線或權限。');
                });
                
                const unsubscribeAssignees = db.collection(ASSIGNEES_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAssignees(data);
                }, (error) => {
                    console.error("Error fetching assignees: ", error);
                });

                return () => {
                    unsubscribeProjects();
                    unsubscribeAssignees();
                };
            }, [db, showNotification]);

            const getAssigneeName = useCallback((assigneeId) => {
                return assignees.find(a => a.id === assigneeId)?.name || '未指派';
            }, [assignees]);

            const getStatusStyle = (status) => {
                switch (status) {
                    case 'New': return 'bg-red-100 text-red-800';
                    case 'In Progress': return 'bg-blue-100 text-blue-800';
                    case 'Completed': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            const StatusBadge = ({ status }) => (
                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusStyle(status)}`}>
                    {status}
                </span>
            );

            const ProjectList = useMemo(() => {
                if (loading) return <p className="text-center py-10 text-gray-500">初始化中...</p>;
                if (!db) return <p className="text-center py-10 text-red-500 font-semibold">資料庫連線失敗。</p>;

                return (
                    <div className="bg-white shadow overflow-hidden sm:rounded-lg mt-6">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">專案名稱</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">狀態</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">處理人</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">操作</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {projects.length === 0 ? (
                                    <tr>
                                        <td colSpan="4" className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">目前沒有專案。</td>
                                    </tr>
                                ) : (
                                    projects.map((project) => (
                                        <tr key={project.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{project.name}</td>
                                            <td className="px-6 py-4 whitespace-nowrap"><StatusBadge status={project.status} /></td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getAssigneeName(project.assigneeId)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button
                                                    onClick={() => setAssigneeModalConfig({
                                                        isOpen: true,
                                                        projectId: project.id,
                                                        projectName: project.name,
                                                        currentAssigneeId: project.assigneeId
                                                    })}
                                                    className="inline-flex items-center px-3 py-1 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                                    disabled={!db}
                                                >
                                                    <Users className="w-4 h-4 mr-2" /> 更換處理人
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                );
            }, [projects, loading, db, getAssigneeName]);

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex justify-between items-center pb-6 border-b border-gray-200">
                            <h1 className="text-3xl font-bold text-gray-900">專案管理儀表板</h1>
                            <div className="flex items-center space-x-4">
                                <div className={`px-3 py-1 rounded-full text-sm font-medium ${isDbConnected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                    DB 狀態: {isDbConnected ? '連線中' : '中斷'}
                                </div>
                                <div className="text-sm text-gray-600">UID: <span className="font-mono">{userId}</span></div>
                            </div>
                        </div>

                        {notification.visible && (
                            <div className={`mt-4 p-4 rounded-md flex items-center ${notification.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                {notification.type === 'success' ? <CheckCircle className="w-5 h-5 mr-3" /> : <XCircle className="w-5 h-5 mr-3" />}
                                <p className="text-sm font-medium">{notification.message}</p>
                            </div>
                        )}

                        {ProjectList}
                        
                        <Modal
                            isOpen={notificationModalConfig.isOpen}
                            title="模擬郵件通知"
                            onClose={() => setNotificationModalConfig({ ...notificationModalConfig, isOpen: false })}
                        >
                            <p className="text-sm text-gray-600 mb-4">這封郵件將會發送給新的處理人。</p>
                            {notificationModalConfig.emailContent && (
                                <div className="bg-gray-50 p-4 rounded-md">
                                    <p className="text-xs text-gray-500 mb-2">收件人: {notificationModalConfig.emailContent.to}</p>
                                    <p className="text-xs text-gray-500 mb-2">主旨: {notificationModalConfig.emailContent.subject}</p>
                                    <pre className="whitespace-pre-wrap font-mono p-3 bg-white border rounded-md text-gray-700">{notificationModalConfig.emailContent.body}</pre>
                                </div>
                            )}
                        </Modal>
                        
                        <Modal
                            isOpen={assigneeModalConfig.isOpen}
                            title="更換專案處理人"
                            onClose={() => setAssigneeModalConfig({ ...assigneeModalConfig, isOpen: false })}
                        >
                            {db && assignees.length > 0 && assigneeModalConfig.projectId && (
                                <AssigneeChangeForm
                                    db={db}
                                    projectId={assigneeModalConfig.projectId}
                                    projectName={assigneeModalConfig.projectName}
                                    currentAssigneeId={assigneeModalConfig.currentAssigneeId}
                                    assignees={assignees}
                                    onClose={() => setAssigneeModalConfig({ ...assigneeModalConfig, isOpen: false })}
                                    showNotification={showNotification}
                                    openEmailModal={openEmailModal}
                                />
                            )}
                        </Modal>
                    </div>
                </div>
            );
        };

        // 確保 DOM 載入完成後再渲染
        window.onload = () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            } else {
                console.error("無法找到 #root 元素");
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案儀表板 - 最終圖標與配置修正</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 設定 Tailwind CSS 配置，使用 Inter 字體和標準色調 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-500': '#4f46e5', // Indigo-600
                        'primary-600': '#4338ca', // Indigo-700
                        'teal-500': '#14b8a6', // For Admin features
                        'teal-600': '#0d9488',
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs (v9 兼容版本) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // -------------------------------------------------------------------
        // 1. 環境變數設定與版本號
        // -------------------------------------------------------------------
        const APP_VERSION = '1.1.4';
        
        // 確保安全地從環境變數載入配置
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // -------------------------------------------------------------------
        // 2. 共用組件 (Shared Components) - 徹底移除外部圖標庫依賴
        // -------------------------------------------------------------------

        const { useState, useEffect, useCallback, useMemo } = React;
        
        // 內聯 SVG 圖標映射 (徹底修正 TypeError: iconFunc is not a function)
        const getSvgIcon = (name, size, className) => {
            const sizePx = `${size}px`;
            const baseProps = `width="${sizePx}" height="${sizePx}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"`;
            
            // 使用內聯 SVG 代碼，特別為 Loader 加入旋轉動畫
            switch (name) {
                case 'Loader': 
                    // This is a spinning SVG loader, ensuring no external dependencies
                    return `<svg ${baseProps}><path d="M21 12a9 9 0 1 1-6.219-8.56"/><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite" /></svg>`;
                case 'User':
                    return `<svg ${baseProps}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
                case 'Calendar':
                    return `<svg ${baseProps}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`;
                case 'X':
                    return `<svg ${baseProps}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
                case 'Save':
                    return `<svg ${baseProps}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`;
                case 'Plus':
                    return `<svg ${baseProps}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`;
                case 'PlusCircle':
                    return `<svg ${baseProps}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`;
                case 'UserCircle':
                    return `<svg ${baseProps}><path d="M18 20a4 4 0 0 0-8 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>`;
                case 'CheckCircle':
                    return `<svg ${baseProps}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14 9 11"/></svg>`;
                case 'UserPlus':
                    return `<svg ${baseProps}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>`;
                case 'Settings':
                    return `<svg ${baseProps}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09A1.65 1.65 0 0 0 15 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`;
                default:
                    return `<svg ${baseProps}><rect width="24" height="24" fill="red"/></svg>`;
            }
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const svgHtml = getSvgIcon(name, size, className);
            // dangerouslySetInnerHTML is required to render the raw SVG string
            return <span className={className} dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} />;
        };

        const LoadingSpinner = ({ message = "正在初始化 Firebase 與身份驗證..." }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4">
                <Icon name="Loader" className="text-primary-500 mb-3" size={48} />
                <p className="text-gray-600 font-medium">{message}</p>
            </div>
        );

        const Notification = ({ message, type, onClose }) => {
            const baseClasses = "fixed bottom-5 right-5 p-4 rounded-xl shadow-xl z-50 transform transition-all duration-300 ease-out min-w-[300px]";
            const typeClasses = {
                success: "bg-green-500 text-white",
                error: "bg-red-500 text-white",
                info: "bg-blue-500 text-white",
            }[type] || "bg-gray-700 text-white";

            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`${baseClasses} ${typeClasses}`}>
                    <div className="flex items-center justify-between">
                        <span className="font-semibold">{message}</span>
                        <button onClick={onClose} className="ml-4 opacity-75 hover:opacity-100">
                            <Icon name="X" size={18} />
                        </button>
                    </div>
                </div>
            );
        };
        
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            
            return (
                <div 
                    className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-40 transition-opacity duration-300"
                    onClick={onClose}
                >
                    <div 
                        className="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 ease-out"
                        onClick={(e) => e.stopPropagation()} 
                    >
                        <div className="flex justify-between items-center p-5 border-b border-gray-100">
                            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
                                <Icon name="X" size={24} />
                            </button>
                        </div>
                        <div className="p-5">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // -------------------------------------------------------------------
        // 3. 核心鉤子 (Core Hook: useFirebase) - 處理初始化、認證、資料同步
        // -------------------------------------------------------------------

        let app, db, auth;
        const isFirebaseConfigValid = Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey;
        
        if (isFirebaseConfigValid) {
             try {
                // 初始化 Firebase
                app = firebase.initializeApp(firebaseConfig, appId);
                auth = firebase.auth(app);
                db = firebase.firestore(app);
                firebase.firestore.setLogLevel('debug');
                console.log("Firebase initialized.");
            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                // In case of error, mark config as invalid to trigger mock mode/error screen
                isFirebaseConfigValid = false; 
            }
        } else {
            console.warn("Firebase Configuration Missing or Invalid. Running in mock mode.");
        }
        
        const useFirebase = () => {
            const [userId, setUserId] = useState(null);
            const [currentUserData, setCurrentUserData] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [projects, setProjects] = useState([]);
            const [assignees, setAssignees] = useState([]); 
            const [logs, setLogs] = useState([]); 

            const getPublicPath = useCallback((collectionName) => 
                `artifacts/${appId}/public/data/${collectionName}`, [appId]);

            const logAction = useCallback(async (action, projectId = null) => {
                if (!db || !userId || !isFirebaseConfigValid) return;
                
                const role = currentUserData?.role || 'guest';
                try {
                    await db.collection(getPublicPath('systemLogs')).add({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: userId,
                        userName: assignees.find(u => u.uid === userId)?.name || 'Unknown User',
                        action: action,
                        projectId: projectId,
                        role: role
                    });
                } catch (e) {
                    console.error("Failed to log action:", e);
                }
            }, [userId, currentUserData, assignees, getPublicPath, isFirebaseConfigValid]);
            
            useEffect(() => {
                if (!isFirebaseConfigValid) {
                    setIsAuthReady(true);
                    return; // Mock mode
                }
                
                let unsubscribeAuth = () => {};
                let unsubscribeUsers = () => {};
                let unsubscribeProjects = () => {};
                let unsubscribeLogs = () => {};
                let unsubscribeCurrentUser = () => {}; 
                
                const initAuth = async () => {
                    // --- 認證流程 ---
                    try {
                        if (auth.currentUser) {
                            console.log("User already signed in:", auth.currentUser.uid);
                        } else if (initialAuthToken) {
                            await auth.signInWithCustomToken(initialAuthToken);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (signError) {
                        console.error("Firebase 認證失敗:", signError.code, signError.message);
                    }
                };
                
                initAuth();

                // --- 狀態變更監聽器 ---
                unsubscribeAuth = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        const currentUserId = user.uid;
                        setUserId(currentUserId);
                        console.log("Auth state changed. User ID:", currentUserId);

                        // 監聽所有使用者 (Assignees)
                        unsubscribeUsers = db.collection(getPublicPath('users')).onSnapshot(snapshot => {
                            const usersData = snapshot.docs.map(doc => doc.data());
                            setAssignees(usersData);
                        }, error => {
                            console.error("Error fetching users:", error);
                        });

                        // 監聽專案資料
                        unsubscribeProjects = db.collection(getPublicPath('projects'))
                            .orderBy('createdAt', 'desc')
                            .onSnapshot(snapshot => {
                                const projectsData = snapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                setProjects(projectsData);
                            }, error => {
                                console.error("Error fetching projects:", error);
                            });

                        // 監聽系統日誌
                        unsubscribeLogs = db.collection(getPublicPath('systemLogs'))
                            .orderBy('timestamp', 'desc')
                            .limit(50) 
                            .onSnapshot(snapshot => {
                                const logsData = snapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                setLogs(logsData);
                            }, error => {
                                console.error("Error fetching logs:", error);
                            });

                        // 實時監聽當前用戶文件 (核心修正註冊後無法切換的問題)
                        const userDocRef = db.collection(getPublicPath('users')).doc(currentUserId);
                        unsubscribeCurrentUser = userDocRef.onSnapshot(doc => {
                            if (doc.exists) {
                                const userData = doc.data();
                                setCurrentUserData(userData);
                                userDocRef.update({ 
                                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                }).catch(e => console.error("Failed to update last login:", e));
                            } else {
                                setCurrentUserData(null); 
                            }
                        }, error => {
                            console.error("Error fetching current user document:", error);
                            setCurrentUserData(null);
                        });
                        
                        setIsAuthReady(true);

                    } else {
                        setUserId(null);
                        setCurrentUserData(null);
                        setIsAuthReady(true); 
                    }
                });

                // 清理函數：組件卸載時移除所有監聽器
                return () => {
                    unsubscribeAuth();
                    unsubscribeUsers();
                    unsubscribeProjects();
                    unsubscribeLogs();
                    unsubscribeCurrentUser(); 
                };
            }, [getPublicPath, isFirebaseConfigValid]); 

            // 實時從 currentUserData 衍生狀態
            const userRole = currentUserData?.role || 'guest';
            const userDept = currentUserData?.department || '未註冊';
            const canManage = userRole === 'admin';

            return {
                db: db,
                userId,
                userRole, 
                userDept, 
                canManage, 
                isAuthReady,
                projects,
                assignees,
                logs,
                logAction,
                getPublicPath,
                isFirebaseConfigValid
            };
        };

        // -------------------------------------------------------------------
        // 4. 專案看板組件 (Project Dashboard Components)
        // -------------------------------------------------------------------
        
        const StatusBadge = ({ status }) => {
            const statusMap = {
                'Pending': 'bg-yellow-100 text-yellow-800',
                'InProgress': 'bg-blue-100 text-blue-800',
                'Completed': 'bg-green-100 text-green-800',
                'OnHold': 'bg-gray-200 text-gray-700',
                'admin': 'bg-teal-100 text-teal-800',
                'user': 'bg-indigo-100 text-indigo-800',
                'guest': 'bg-red-100 text-red-800',
                '未註冊': 'bg-red-100 text-red-800',
            };
            const textMap = {
                'Pending': '待處理',
                'InProgress': '進行中',
                'Completed': '已完成',
                'OnHold': '暫停',
                'admin': '管理員',
                'user': '一般用戶',
                'guest': '訪客',
                '未註冊': '未註冊',
            };
            const classes = statusMap[status] || 'bg-gray-100 text-gray-600';
            const displayStatus = textMap[status] || status;
            return (
                <span className={`inline-flex items-center px-3 py-1 text-xs font-medium rounded-full ${classes}`}>
                    {displayStatus}
                </span>
            );
        };

        const ProjectCard = ({ project, assignees, onEdit, userId }) => {
            const assignee = assignees.find(a => a.uid === project.assigneeId);
            const isAssigned = project.assigneeId === userId;
            const titleClasses = isAssigned ? "text-primary-600 font-bold" : "text-gray-800 font-semibold";
            
            return (
                <div className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-5 flex flex-col justify-between border border-gray-100">
                    <div>
                        <div className="flex justify-between items-start mb-3">
                            <h4 className={`text-lg ${titleClasses} truncate pr-2`} title={project.name}>{project.name}</h4>
                            <StatusBadge status={project.status} />
                        </div>
                        <p className="text-sm text-gray-600 mb-4 line-clamp-3">{project.description || "無描述"}</p>
                    </div>
                    <div>
                        <div className="flex justify-between items-center text-sm text-gray-500 mt-2 border-t pt-3">
                            <div className="flex items-center">
                                <Icon name="User" size={16} className="mr-1 text-gray-400" />
                                <span className="truncate" title={assignee?.name}>
                                    {assignee ? (isAssigned ? '我' : assignee.name) : '未指派'}
                                    {assignee?.department && ` (${assignee.department})`}
                                </span>
                            </div>
                            <div className="flex items-center">
                                <Icon name="Calendar" size={16} className="mr-1 text-gray-400" />
                                <span>
                                    {project.dueDate ? new Date(project.dueDate).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }) : 'N/A'}
                                </span>
                            </div>
                        </div>
                        <button 
                            onClick={() => onEdit(project)}
                            className="mt-4 w-full text-center text-sm font-medium py-2 rounded-lg text-primary-500 hover:bg-primary-50 transition-colors"
                        >
                            查看詳情 / 編輯
                        </button>
                    </div>
                </div>
            );
        };

        const ProjectForm = ({ project, assignees, onSubmit, onClose, canManage }) => {
            const isEditMode = !!project;
            const initialDate = isEditMode && project.dueDate ? project.dueDate : new Date().toISOString().substring(0, 10);
            const [formData, setFormData] = useState(project || { name: '', description: '', status: 'Pending', assigneeId: '', dueDate: initialDate });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };

            const statusOptions = ['Pending', 'InProgress', 'Completed', 'OnHold'];

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <input type="text" name="name" value={formData.name} onChange={handleChange} required placeholder="專案名稱"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" />
                    
                    <textarea name="description" value={formData.description} onChange={handleChange} rows="3" placeholder="專案描述"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150"></textarea>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <select name="status" value={formData.status} onChange={handleChange} required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150">
                            {statusOptions.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                        
                        <input type="date" name="dueDate" value={formData.dueDate} onChange={handleChange} required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" />
                    </div>

                    <select name="assigneeId" value={formData.assigneeId} onChange={handleChange}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150"
                        disabled={!canManage && isEditMode}
                    >
                        <option value="">未指派</option>
                        {assignees
                            .filter(a => a.role !== 'guest') 
                            .map(a => (
                            <option key={a.uid} value={a.uid}>{a.name} ({a.department || 'N/A'})</option>
                        ))}
                    </select>
                    {!canManage && isEditMode && (
                        <p className="text-xs text-gray-500 mt-1">只有管理員才能修改指派人員。</p>
                    )}

                    <div className="flex justify-end space-x-3 mt-5">
                        <button type="button" onClick={onClose}
                            className="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                            取消
                        </button>
                        <button type="submit"
                            className="px-4 py-2 bg-primary-500 text-white font-semibold rounded-lg shadow-md hover:bg-primary-600 transition-colors">
                            <div className="flex items-center justify-center">
                                <Icon name={isEditMode ? 'Save' : 'Plus'} size={18} className="mr-1" />
                                <span>{isEditMode ? '更新專案' : '新增專案'}</span>
                            </div>
                        </button>
                    </div>
                </form>
            );
        };
        
        const UserRegistrationForm = ({ assignees, getPublicPath, db, showNotification, logAction, onClose }) => {
            const [formData, setFormData] = useState({ name: '', employeeId: '', department: '企劃' });
            const [isLoading, setIsLoading] = useState(false);
            const departments = ['企劃', '設計', '商品', '營業', 'Admin'];

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!db) return showNotification("資料庫未連接。", "error");
                
                if (!formData.name || !formData.employeeId) {
                    return showNotification("姓名和員編為必填項。", "error");
                }

                setIsLoading(true);

                try {
                    const employeeIdExists = assignees.some(a => a.employeeId === formData.employeeId);
                    if (employeeIdExists) {
                        setIsLoading(false);
                        return showNotification(`員編 ${formData.employeeId} 已存在，請使用其他員編。`, "error");
                    }
                    
                    const newUid = crypto.randomUUID();
                    const userRef = db.collection(getPublicPath('users')).doc(newUid);

                    const roleToAssign = formData.department === 'Admin' ? 'admin' : 'user';

                    await userRef.set({
                        uid: newUid,
                        name: formData.name,
                        employeeId: formData.employeeId,
                        department: formData.department,
                        role: roleToAssign, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });

                    logAction(`[Admin] 預先註冊了新用戶: ${formData.name} (${formData.employeeId})`, newUid);
                    showNotification(`用戶 ${formData.name} (角色: ${roleToAssign}) 註冊成功！`, "success");
                    
                    setFormData({ name: '', employeeId: '', department: '企劃' });
                    onClose();
                    
                } catch (e) {
                    console.error("User registration failed:", e);
                    showNotification("用戶註冊失敗，請檢查權限設定或網路連接。", "error");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h4 className="text-lg font-semibold text-gray-700 border-b pb-2">新增企業內部員工資料</h4>
                    
                    <input type="text" name="name" value={formData.name} onChange={handleChange} required placeholder="姓名"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150" />
                    
                    <input type="text" name="employeeId" value={formData.employeeId} onChange={handleChange} required placeholder="員編 (唯一識別碼)"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150" />
                    
                    <select name="department" value={formData.department} onChange={handleChange} required
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                        {departments.map(d => <option key={d} value={d}>{d}</option>)}
                    </select>
                    
                    <div className="pt-2">
                        <button type="submit" disabled={isLoading}
                            className={`w-full px-4 py-3 text-white font-semibold rounded-lg shadow-lg transition-colors flex items-center justify-center ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-teal-500 hover:bg-teal-600'}`}>
                            {isLoading ? <Icon name="Loader" size={20} className="mr-2" /> : <Icon name="UserPlus" size={20} className="mr-2" />}
                            <span>{isLoading ? '正在處理...' : '確定新增用戶'}</span>
                        </button>
                    </div>
                </form>
            );
        };
        
        const AdminManagementModal = ({ assignees, logs, db, getPublicPath, logAction, showNotification, onClose }) => {
            const [activeTab, setActiveTab] = useState('users');

            const roleMap = { 'admin': '管理員', 'user': '一般用戶', 'guest': '訪客' };

            const LogItem = ({ log }) => (
                <div className="p-3 border-b border-gray-100 text-sm">
                    <span className="font-semibold text-gray-700">{log.userName}</span> 
                    <span className="text-gray-500"> ({roleMap[log.role] || log.role}) </span>
                    <span className="text-primary-500 ml-1">{log.action}</span>
                    <span className="block text-xs text-gray-400 mt-0.5">
                        {log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleDateString('zh-TW', { hour: '2-digit', minute: '2-digit', month: '2-digit', day: '2-digit' }) : 'N/A'}
                    </span>
                </div>
            );
            
            const UserList = ({ users }) => (
                <div className="space-y-3 max-h-80 overflow-y-auto">
                    {users.map(user => (
                        <div key={user.uid} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p className="font-semibold text-gray-800">{user.name} 
                                    {user.employeeId && <span className="text-xs ml-2 text-primary-500">({user.employeeId})</span>}
                                </p>
                                <p className="text-xs text-gray-500 truncate" title={user.uid}>UID: {user.uid.substring(0, 8)}...</p>
                                <p className="text-xs text-gray-600 mt-1">部門: {user.department || 'N/A'}</p>
                            </div>
                            <StatusBadge status={user.role || '未設定'} />
                        </div>
                    ))}
                </div>
            );

            return (
                <Modal isOpen={true} onClose={onClose} title="管理員面板">
                    <div className="border-b mb-4">
                        <nav className="flex space-x-4">
                            <button 
                                onClick={() => setActiveTab('users')} 
                                className={`py-2 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'users' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                用戶清單 ({assignees.length})
                            </button>
                            <button 
                                onClick={() => setActiveTab('register')} 
                                className={`py-2 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'register' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                管理員註冊用戶
                            </button>
                            <button 
                                onClick={() => setActiveTab('logs')} 
                                className={`py-2 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'logs' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                系統日誌 ({logs.length})
                            </button>
                        </nav>
                    </div>

                    {activeTab === 'users' && <UserList users={assignees} />}

                    {activeTab === 'register' && (
                        <UserRegistrationForm 
                            assignees={assignees} 
                            db={db} 
                            getPublicPath={getPublicPath}
                            showNotification={showNotification}
                            logAction={logAction}
                            onClose={() => setActiveTab('users')}
                        />
                    )}

                    {activeTab === 'logs' && (
                        <div className="space-y-1 max-h-80 overflow-y-auto bg-white rounded-lg border">
                            {logs.map(log => <LogItem key={log.id} log={log} />)}
                        </div>
                    )}
                </Modal>
            );
        };
        
        const SelfRegistrationForm = ({ userId, db, getPublicPath, assignees, showNotification }) => {
            const [formData, setFormData] = useState({ name: '', employeeId: '', department: '企劃' });
            const [isLoading, setIsLoading] = useState(false);
            const departments = ['企劃', '設計', '商品', '營業'];

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!db) return showNotification("資料庫未連接。", "error");
                
                if (!formData.name || !formData.employeeId) {
                    return showNotification("姓名和員編為必填項。", "error");
                }
                
                setIsLoading(true);

                try {
                    const employeeIdExists = assignees.some(a => a.employeeId === formData.employeeId);
                    if (employeeIdExists) {
                        setIsLoading(false);
                        return showNotification(`員編 ${formData.employeeId} 已存在，請聯繫管理員。`, "error");
                    }
                    
                    const userRef = db.collection(getPublicPath('users')).doc(userId);
                    
                    await userRef.set({
                        uid: userId,
                        name: formData.name,
                        employeeId: formData.employeeId,
                        department: formData.department,
                        role: 'user', 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    });

                    showNotification(`註冊成功！歡迎 ${formData.name}。您現在可以進入儀表板。`, "success");
                    
                } catch (e) {
                    console.error("Self-registration failed:", e);
                    showNotification("註冊失敗，請檢查網路或聯繫管理員。", "error");
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="max-w-md mx-auto p-8 bg-white rounded-xl shadow-2xl mt-10">
                    <div className="text-center mb-6">
                        <Icon name="UserCircle" size={48} className="text-primary-500 mx-auto mb-3" />
                        <h2 className="text-2xl font-bold text-gray-800">用戶自主註冊</h2>
                        <p className="text-sm text-gray-500 mt-1">請填寫您的企業資料以開始使用儀表板。</p>
                        <p className="text-xs text-gray-400 mt-1">您的暫時 ID: {userId ? userId.substring(0, 8) + '...' : 'N/A'}</p>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input type="text" name="name" value={formData.name} onChange={handleChange} required placeholder="姓名"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" />
                        
                        <input type="text" name="employeeId" value={formData.employeeId} onChange={handleChange} required placeholder="員編 (登入的唯一識別碼)"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150" />
                        
                        <select name="department" value={formData.department} onChange={handleChange} required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150">
                            {departments.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                        
                        <button type="submit" disabled={isLoading}
                            className={`w-full px-4 py-3 text-white font-semibold rounded-lg shadow-md transition-colors flex items-center justify-center ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-primary-500 hover:bg-primary-600'}`}>
                            {isLoading ? (
                                <>
                                    <Icon name="Loader" size={20} className="mr-2" />
                                    <span>正在註冊...</span>
                                </>
                            ) : (
                                <>
                                    <Icon name="CheckCircle" size={20} className="mr-2" />
                                    <span>完成註冊並進入儀表板</span>
                                </>
                            )}
                        </button>
                    </form>
                </div>
            );
        };


        // 5. App Component - 主應用程式
        const App = () => {
            const { 
                db, 
                userId, 
                userRole, 
                userDept, 
                canManage, 
                isAuthReady, 
                projects, 
                assignees, 
                logs, 
                logAction,
                getPublicPath,
                isFirebaseConfigValid
            } = useFirebase();
            
            const [notification, setNotification] = useState(null);
            const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [adminManagementModalOpen, setAdminManagementModalOpen] = useState(false);

            const showNotification = useCallback((message, type = 'info') => {
                setNotification({ message, type });
            }, []);

            const handleProjectSubmit = async (formData) => {
                if (!db || !userId) return showNotification("應用程式未準備好，請稍候。", "error");

                try {
                    const projectsCollection = db.collection(getPublicPath('projects'));
                    
                    if (editingProject) {
                        await projectsCollection.doc(editingProject.id).update(formData);
                        logAction(`更新了專案: ${formData.name}`, editingProject.id);
                        showNotification("專案更新成功！", "success");
                    } else {
                        const newDoc = await projectsCollection.add({
                            ...formData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: userId,
                        });
                        logAction(`新增了專案: ${formData.name}`, newDoc.id);
                        showNotification("專案新增成功！", "success");
                    }
                    
                    setIsProjectModalOpen(false);
                    setEditingProject(null);
                } catch (e) {
                    console.error("Project submission failed:", e);
                    showNotification("操作失敗，請檢查日誌，可能是權限問題。", "error");
                }
            };
            
            const handleEditProject = (project) => {
                setEditingProject({ 
                    ...project, 
                    dueDate: project.dueDate.substring(0, 10) 
                });
                setIsProjectModalOpen(true);
            };

            const handleOpenAdd = () => {
                if (!isFirebaseConfigValid) {
                    return showNotification("資料庫未連接，無法新增專案。", "error");
                }
                setEditingProject(null);
                setIsProjectModalOpen(true);
            }


            if (!isAuthReady) {
                // Simplified Loading Spinner call
                return <LoadingSpinner />;
            }
            
            if (!userId) {
                 return (
                    <div className="p-8 max-w-4xl mx-auto text-center">
                        <h1 className="text-3xl font-bold text-red-600 mb-4">無法識別用戶身份</h1>
                        <p className="text-gray-600">
                            應用程式無法完成 Firebase 認證。請檢查您的配置。
                        </p>
                    </div>
                );
            }
            
            // 強制顯示自主註冊表單
            if (userRole === 'guest') {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                        <SelfRegistrationForm 
                            userId={userId} 
                            db={db}
                            getPublicPath={getPublicPath}
                            assignees={assignees}
                            showNotification={showNotification}
                        />
                         {notification && (
                            <Notification 
                                message={notification.message} 
                                type={notification.type} 
                                onClose={() => setNotification(null)}
                            />
                        )}
                    </div>
                );
            }


            const groupedProjects = projects.reduce((acc, project) => {
                acc[project.status] = acc[project.status] || [];
                acc[project.status].push(project);
                return acc;
            }, {});

            const statusOrder = ['Pending', 'InProgress', 'Completed', 'OnHold'];

            return (
                <div className="p-4 md:p-8">
                    {notification && (
                        <Notification 
                            message={notification.message} 
                            type={notification.type} 
                            onClose={() => setNotification(null)}
                        />
                    )}

                    <div className="max-w-7xl mx-auto">
                        {/* 標題與操作區 */}
                        <header className="flex justify-between items-center mb-6 border-b pb-4">
                            <h1 className="text-3xl font-extrabold text-gray-900">
                                專案儀表板 
                                <span className="text-sm font-medium text-gray-500 ml-2">
                                    （角色: {userRole}，部門: {userDept}）
                                </span>
                            </h1>
                            <div className="flex items-center space-x-3">
                                <span className="text-xs text-gray-500 mr-4">v{APP_VERSION}</span> 
                                {canManage && (
                                    <button 
                                        onClick={() => setAdminManagementModalOpen(true)}
                                        className="flex items-center px-4 py-2 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600 transition-colors"
                                    >
                                        <Icon name="Settings" size={20} className="mr-2" /> 管理面板
                                    </button>
                                )}
                                <button 
                                    onClick={handleOpenAdd}
                                    className="flex items-center px-4 py-2 bg-primary-500 text-white font-semibold rounded-lg shadow-md hover:bg-primary-600 transition-colors"
                                >
                                    <Icon name="PlusCircle" size={20} className="mr-2" /> 新增專案
                                </button>
                            </div>
                        </header>

                        {/* 專案看板 */}
                        <main className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            {statusOrder.map(status => (
                                <div key={status} className="p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <h3 className="text-lg font-bold mb-4 flex items-center text-gray-700">
                                        <StatusBadge status={status} />
                                        <span className="ml-2">
                                            {status === 'Pending' ? '待處理' : status === 'InProgress' ? '進行中' : status === 'Completed' ? '已完成' : '暫停'}
                                        </span>
                                        <span className="ml-2 text-sm font-medium text-gray-400">({groupedProjects[status]?.length || 0})</span>
                                    </h3>
                                    <div className="space-y-4 min-h-[100px]">
                                        {groupedProjects[status]?.map(project => (
                                            <ProjectCard 
                                                key={project.id} 
                                                project={project} 
                                                assignees={assignees} 
                                                onEdit={handleEditProject} 
                                                userId={userId} 
                                            />
                                        ))}
                                        {(!groupedProjects[status] || groupedProjects[status].length === 0) && (
                                            <p className="text-sm text-gray-400 text-center py-6 border border-dashed rounded-lg">此狀態下沒有專案。</p>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </main>
                        
                        {/* 模態框：新增/編輯專案 */}
                        <Modal 
                            isOpen={isProjectModalOpen} 
                            onClose={() => setIsProjectModalOpen(false)} 
                            title={editingProject ? '編輯專案' : '新增專案'}
                        >
                            <ProjectForm
                                project={editingProject}
                                assignees={assignees}
                                onSubmit={handleProjectSubmit}
                                onClose={() => setIsProjectModalOpen(false)}
                                canManage={canManage}
                            />
                        </Modal>
                        
                        {/* 模態框：管理員面板 */}
                        {canManage && db && adminManagementModalOpen && ( 
                            <AdminManagementModal
                                assignees={assignees}
                                logs={logs}
                                db={db}
                                getPublicPath={getPublicPath}
                                logAction={logAction}
                                showNotification={showNotification}
                                onClose={() => setAdminManagementModalOpen(false)}
                            />
                        )}

                    </div>
                </div>
            );
        };

        // 確保 DOM 載入完成後再渲染
        window.onload = () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            } else {
                console.error("無法找到 #root 元素");
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¡ˆå„€è¡¨æ¿ - æ¬Šé™å„ªåŒ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¨­å®š Tailwind CSS é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«”å’Œæ¨™æº–è‰²èª¿ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-500': '#4f46e5', // Indigo-600
                        'primary-600': '#4338ca', // Indigo-700
                        'teal-500': '#14b8a6', // For Admin features
                        'teal-600': '#0d9488',
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs (ä½¿ç”¨å…¼å®¹ç‰ˆæœ¬) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- React & ReactDOM (æŒ‡å®šç‰ˆæœ¬ 18.2.0) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // ----------------------------------------------------------------------
        // 0. CONSTANTS & UTILITIES
        // ----------------------------------------------------------------------
        
        // ** Canvas ç’°å¢ƒ App ID **
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ** Firestore Collection Paths **
        const PROJECTS_PATH = `artifacts/${appId}/public/data/projects`;
        const ASSIGNEES_PATH = `artifacts/${appId}/public/data/assignees`;
        const PRESENCE_PATH = `artifacts/${appId}/public/data/presence`;
        const USER_PROFILES_PATH = `artifacts/${appId}/public/data/userProfiles`;
        
        // ** ç®¡ç†å“¡ ID (ç”¨æ–¼ç¤ºç¯„æ¬Šé™æ§åˆ¶) **
        const ADMIN_ID = '15152491164772220861'; 
        const ADMIN_EMAIL = 'system.admin@canvas.com'; // ç®¡ç†å“¡é è¨­ Email
        

        // å°ˆæ¡ˆç‹€æ…‹é¸é …
        const STATUS_OPTIONS = ['New', 'In Progress', 'Completed'];
        
        // æä¾›çš„ Firebase è¨­å®šä½œç‚º fallback (è‹¥ Canvas ç’°å¢ƒæœªæä¾›å‰‡ä½¿ç”¨æ­¤é…ç½®)
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyCMiLg3coEoLeVtLmfEK_zlAHsHZ-yZfP0",
            authDomain: "project-407d1.firebaseapp.com",
            projectId: "project-407d1",
            storageBucket: "project-407d1.firebaseapp.com",
            messagingSenderId: "524548363140",
            appId: "1:524548363140:web:7b7dedc2a70faf5790c3d1",
            measurementId: "G-QXYBX3MFXE"
        };
        
        // å„ªå…ˆä½¿ç”¨ Canvas ç’°å¢ƒæä¾›çš„è¨­å®š (__firebase_config)ï¼Œå¦å‰‡ä½¿ç”¨é è¨­é…ç½®
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : defaultFirebaseConfig;

        let app;
        let db;
        let authInstance;
        
        /**
         * åˆå§‹åŒ– Firebase æœå‹™ä¸¦åŸ·è¡Œç™»å…¥ã€‚
         */
        const initFirebase = async () => {
            try {
                if (!app) {
                    // åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼
                    app = firebase.initializeApp(firebaseConfig);
                    authInstance = firebase.auth(app);
                    db = firebase.firestore(app);
                }
                
                // è™•ç† Canvas Custom Token æˆ–åŒ¿åç™»å…¥
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                let userCredential;

                console.log(`[Init] Firebase Init: Attempting sign-in (Token provided: ${!!token})`);
                
                if (token) {
                    userCredential = await authInstance.signInWithCustomToken(token);
                } else {
                    userCredential = await authInstance.signInAnonymously();
                }
                
                const userId = userCredential.user.uid;
                console.log(`[Init] Sign-in Success. Resolved User ID: ${userId}`);
                
                return { db, authInstance, userId };
            } catch (error) {
                console.error("[CRITICAL] Firebase åˆå§‹åŒ–æˆ–ç™»å…¥å¤±æ•—:", error);
                return { db: null, authInstance: null, userId: 'ERROR' }; 
            }
        };

        // ----------------------------------------------------------------------
        // 1. ICON COMPONENTS (Reusable SVGs)
        // ----------------------------------------------------------------------
        
        const IconWrapper = ({ children, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg> 
        );

        const Users = (props) => (
            <IconWrapper {...props}>
                <path d="M16 21v-2a4 4 4 0 0 0-4-4H6a4 4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M22 21v-2a4 4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 4 0 0 1 0 7.75" />
            </IconWrapper>
        );
        
        const PlusCircle = (props) => (
            <IconWrapper {...props}>
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="16" />
                <line x1="8" y1="12" x2="16" y2="12" />
            </IconWrapper>
        );

        const CheckCircle = (props) => (
            <IconWrapper {...props}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </IconWrapper>
        );

        const XCircle = (props) => (
            <IconWrapper {...props}>
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
            </IconWrapper>
        );

        const AlertTriangle = (props) => (
            <IconWrapper {...props}>
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
            </IconWrapper>
        );

        const Settings = (props) => (
            <IconWrapper {...props}>
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-.77 1.58L8.14 7.23a2 2 0 0 0-.25 2.82l.06.07a2 2 0 0 1-.32 2.65L6.1 14.88a2 2 0 0 0-.46 2.05l.39 1.16a2 2 0 0 1-.1 1.74l-.19.46a2 2 0 0 0 1.15 2.63l.36.16a2 2 0 0 1 1.63 0l1.6-.68a2 2 0 0 0 2.22 0l1.6.68a2 2 0 0 1 1.63 0l.36-.16a2 2 0 0 0 1.15-2.63l-.19-.46a2 2 0 0 1-.1-1.74l.39-1.16a2 2 0 0 0-.46-2.05l-1.6-1.66a2 2 0 0 1-.32-2.65l.06-.07a2 2 0 0 0-.25-2.82l-2.6-2.6a2 2 0 0 1-.77-1.58V4a2 2 0 0 0-2-2z" />
                <circle cx="12" cy="12" r="3" />
            </IconWrapper>
        );
        
        const UserCheck = (props) => (
            <IconWrapper {...props}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <polyline points="16 11 18 13 22 9" />
            </IconWrapper>
        );
        
        const Trash = (props) => (
            <IconWrapper {...props}>
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            </IconWrapper>
        );


        // ----------------------------------------------------------------------
        // 2. REUSABLE UI COMPONENTS
        // ----------------------------------------------------------------------

        /**
         * å°ˆæ¡ˆç‹€æ…‹æ¨™ç±¤
         */
        const StatusBadge = ({ status }) => {
            let style = 'bg-gray-100 text-gray-800';
            switch (status) {
                case 'New': style = 'bg-red-100 text-red-700 ring-red-500/10'; break;
                case 'In Progress': style = 'bg-primary-50 text-primary-600 ring-primary-500/10'; break;
                case 'Completed': style = 'bg-green-100 text-green-700 ring-green-500/10'; break;
                default: style = 'bg-gray-100 text-gray-700 ring-gray-500/10';
            }
            return (
                <span className={`inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ${style} ring-1 ring-inset`}>
                    {status}
                </span>
            );
        };

        /**
         * é€šç”¨æ¨¡æ…‹æ¡†
         */
        const Modal = ({ isOpen, title, children, onClose, className = "max-w-lg" }) => {
            if (!isOpen) return null;
            return (
                <div 
                    className="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300"
                    onClick={onClose} // é»æ“Šå¤–éƒ¨å€åŸŸé—œé–‰
                >
                    <div 
                        className={`bg-white rounded-xl shadow-2xl w-full ${className} transition-transform duration-300 transform scale-100`} 
                        onClick={(e) => e.stopPropagation()} // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¤–éƒ¨å€åŸŸ
                    >
                        <div className="p-6">
                            <div className="flex justify-between items-center border-b border-gray-100 pb-4 mb-4">
                                <h3 className="text-xl font-bold text-gray-900">{title}</h3>
                                {onClose && (
                                    <button 
                                        onClick={onClose} 
                                        className="text-gray-400 hover:text-gray-600 transition p-1 rounded-full hover:bg-gray-100"
                                    >
                                        <XCircle className="w-6 h-6" />
                                    </button>
                                )}
                            </div>
                            <div>
                                {children}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        /**
         * æ¨¡æ“¬éƒµä»¶é€šçŸ¥æ¨¡æ…‹æ¡† (åŒ…å«é©—è­‰ä¿¡æç¤º)
         */
        const EmailNotificationModal = ({ isOpen, emailContent, onClose, isVerification = false }) => {
            return (
                <Modal 
                    isOpen={isOpen} 
                    title={isVerification ? "æ¨¡æ“¬ï¼šè¨»å†Šé©—è­‰æµç¨‹" : "æ¨¡æ“¬éƒµä»¶é€šçŸ¥"} 
                    onClose={onClose}
                >
                    <div className={`${isVerification ? 'bg-yellow-50 border-yellow-400' : 'bg-gray-50 border-gray-200'} border-l-4 p-4 rounded-lg mb-4`}>
                        <p className={`text-sm font-semibold mb-2 ${isVerification ? 'text-yellow-800' : 'text-gray-800'}`}>
                            {isVerification ? 'ğŸš¨ éƒµä»¶é©—è­‰æç¤º (æ¨¡æ“¬)' : 'é€šçŸ¥éƒµä»¶å…§å®¹'}
                        </p>
                        <p className="text-xs text-gray-600">
                            {isVerification 
                                ? 'åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œè¨»å†ŠæˆåŠŸå¾Œç³»çµ±æœƒç™¼é€ä¸€å°å¸¶æœ‰é©—è­‰é€£çµçš„ä¿¡ä»¶åˆ°æ­¤ Emailã€‚' 
                                : 'é€™å°æ¨¡æ“¬éƒµä»¶å°‡æœƒç™¼é€çµ¦æ–°çš„è™•ç†äººã€‚'}
                        </p>
                    </div>
                    
                    {emailContent && (
                        <div className="p-4 rounded-lg border border-gray-200">
                            <p className="text-sm font-semibold mb-2 text-gray-800">æ”¶ä»¶äºº: <span className="font-normal text-gray-600">{emailContent.to}</span></p>
                            <p className="text-sm font-semibold mb-3 text-gray-800">ä¸»æ—¨: <span className="font-normal text-gray-600">{emailContent.subject}</span></p>
                            <div className="border-t pt-3">
                                <h4 className="text-xs font-medium text-gray-500 uppercase mb-2">éƒµä»¶å…§å®¹:</h4>
                                <pre className="whitespace-pre-wrap font-mono text-sm text-gray-700 bg-white p-3 rounded-md border">{emailContent.body}</pre>
                            </div>
                        </div>
                    )}
                    <div className="flex justify-end mt-4">
                        <button
                            onClick={onClose}
                            className="px-4 py-2 text-sm font-medium text-white bg-primary-500 rounded-lg shadow-md hover:bg-primary-600 transition"
                        >
                            {isVerification ? 'äº†è§£' : 'é—œé–‰'}
                        </button>
                    </div>
                </Modal>
            );
        };
        
        /**
         * ç”¨æˆ¶è¨»å†Šæ¨¡æ…‹æ¡† (æ–°å¢ Email æ¬„ä½)
         */
        const UserRegistrationModal = ({ db, userId, onRegistrationSuccess, showNotification, onClose, openEmailModal }) => {
            const [name, setName] = useState('');
            const [employeeId, setEmployeeId] = useState('');
            const [email, setEmail] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const isClosable = !!onClose; 

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim() || !employeeId.trim() || !email.trim()) return;

                setIsSubmitting(true);
                
                try {
                    const trimmedName = name.trim();
                    const trimmedEmail = email.trim();
                    const trimmedEmployeeId = employeeId.trim();

                    // 1. å„²å­˜ç”¨æˆ¶å€‹äººè³‡æ–™ (Profile)
                    const profileData = {
                        name: trimmedName,
                        employeeId: trimmedEmployeeId,
                        email: trimmedEmail,
                        userId: userId,
                        isVerified: false, // è¨»å†Šå¾Œéœ€è¦é©—è­‰
                        registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    };
                    const profileRef = db.collection(USER_PROFILES_PATH).doc(userId);
                    await profileRef.set(profileData);

                    // 2. å°‡ç”¨æˆ¶åŒæ™‚æ–°å¢ç‚ºå°ˆæ¡ˆè™•ç†äºº (Assignee)
                    const assigneeData = {
                        id: userId,
                        name: trimmedName,
                        employeeId: trimmedEmployeeId,
                        email: trimmedEmail,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    };
                    const assigneeRef = db.collection(ASSIGNEES_PATH).doc(userId);
                    await assigneeRef.set(assigneeData);

                    // 3. æ¨¡æ“¬ç™¼é€é©—è­‰ä¿¡
                    const emailBody = `è«‹é»æ“Šä»¥ä¸‹é€£çµé©—è­‰æ‚¨çš„å¸³æˆ¶ï¼š[æ¨¡æ“¬é©—è­‰é€£çµ]`;
                    openEmailModal(trimmedEmail, `[Action Required] è«‹é©—è­‰æ‚¨çš„å¸³æˆ¶`, emailBody, true);


                    showNotification('success', `è¨»å†ŠæˆåŠŸï¼é©—è­‰ä¿¡å·²ç™¼é€åˆ° ${trimmedEmail}ã€‚è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ï¼`);
                    onRegistrationSuccess(profileData); 
                } catch (error) {
                    console.error("ç”¨æˆ¶è¨»å†Šå¤±æ•—:", error);
                    showNotification('error', 'ç”¨æˆ¶è¨»å†Šå¤±æ•—ã€‚è«‹æª¢æŸ¥ Console ç²å–è©³ç´°è³‡è¨Šã€‚');
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            return (
                <Modal 
                    isOpen={true} 
                    title="ğŸ‘‹ é¦–æ¬¡ç™»å…¥ï¼šè«‹å…ˆå®Œæˆè¨»å†Š" 
                    onClose={isClosable ? onClose : null} 
                    className="max-w-md"
                >
                    <form onSubmit={handleSubmit}>
                        <div className="space-y-4">
                            <p className="text-sm text-gray-600 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                ç‚ºäº†è¿½è¹¤å°ˆæ¡ˆã€æŒ‡æ´¾è™•ç†äººä¸¦ç™¼é€é€šçŸ¥ï¼Œè«‹æä¾›æ‚¨çš„åŸºæœ¬è³‡è¨Šã€‚
                            </p>
                            
                            {/* å§“å (Name) */}
                            <div>
                                <label htmlFor="user-name" className="block text-sm font-semibold text-gray-700 mb-1">æ‚¨çš„å§“å</label>
                                <input
                                    id="user-name"
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="ä¾‹å¦‚ï¼šé™³å¤§æ˜"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                    required
                                    disabled={isSubmitting}
                                />
                            </div>

                            {/* å“¡å·¥ç·¨è™Ÿ (Employee ID) */}
                            <div>
                                <label htmlFor="employee-id" className="block text-sm font-semibold text-gray-700 mb-1">å“¡å·¥ç·¨è™Ÿ</label>
                                <input
                                    id="employee-id"
                                    type="text"
                                    value={employeeId}
                                    onChange={(e) => setEmployeeId(e.target.value)}
                                    placeholder="ä¾‹å¦‚ï¼šE12345"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                    required
                                    disabled={isSubmitting}
                                />
                            </div>

                            {/* Email æ¬„ä½ */}
                            <div>
                                <label htmlFor="user-email" className="block text-sm font-semibold text-gray-700 mb-1">Email (ç”¨æ–¼æŒ‡æ´¾é€šçŸ¥åŠé©—è­‰)</label>
                                <input
                                    id="user-email"
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="ä¾‹å¦‚ï¼šda-ming@company.com"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                    required
                                    disabled={isSubmitting}
                                />
                            </div>
                        </div>

                        <div className="flex justify-end space-x-3 mt-6">
                            {isClosable && (
                                <button 
                                    type="button" 
                                    onClick={onClose} 
                                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                                    disabled={isSubmitting}
                                >
                                    ç¨å¾Œè¨»å†Š
                                </button>
                            )}
                            <button 
                                type="submit" 
                                className="px-4 py-2 text-sm font-medium text-white bg-primary-500 rounded-lg shadow-md hover:bg-primary-600 transition disabled:bg-primary-400"
                                disabled={isSubmitting || !name.trim() || !employeeId.trim() || !email.trim()}
                            >
                                {isSubmitting ? 'è¨»å†Šä¸­...' : 'ç¢ºèªè¨»å†Šä¸¦ç™¼é€é©—è­‰ä¿¡'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };
        
        /**
         * æ–°å¢å°ˆæ¡ˆè¡¨å–®
         */
        const AddProjectForm = ({ db, assignees, onClose, showNotification }) => {
            const [name, setName] = useState('');
            const [status, setStatus] = useState(STATUS_OPTIONS[0]); // Default to 'New'
            const [assigneeId, setAssigneeId] = useState(''); // Allow unassigned
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim()) return;

                setIsSubmitting(true);
                
                try {
                    const newProject = {
                        name: name.trim(),
                        status: status,
                        assigneeId: assigneeId || null, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    };
                    
                    await db.collection(PROJECTS_PATH).add(newProject);

                    showNotification('success', `æˆåŠŸæ–°å¢å°ˆæ¡ˆ: [${name.trim()}]ã€‚`);
                    onClose();
                } catch (error) {
                    console.error("æ–°å¢å°ˆæ¡ˆå¤±æ•—:", error);
                    showNotification('error', 'æ–°å¢å°ˆæ¡ˆå¤±æ•—ã€‚è«‹æª¢æŸ¥ Console ç²å–è©³ç´°è³‡è¨Šã€‚');
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            return (
                <form onSubmit={handleSubmit}>
                    <div className="space-y-4">
                        {/* Project Name */}
                        <div>
                            <label htmlFor="project-name" className="block text-sm font-semibold text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                            <input
                                id="project-name"
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="è¼¸å…¥æ–°å°ˆæ¡ˆåç¨±"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                required
                                disabled={isSubmitting}
                            />
                        </div>

                        {/* Status */}
                        <div>
                            <label htmlFor="project-status" className="block text-sm font-semibold text-gray-700 mb-1">å°ˆæ¡ˆç‹€æ…‹</label>
                            <select
                                id="project-status"
                                value={status}
                                onChange={(e) => setStatus(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                disabled={isSubmitting}
                            >
                                {STATUS_OPTIONS.map((s) => (
                                    <option key={s} value={s}>{s}</option>
                                ))}
                            </select>
                        </div>

                        {/* Assignee */}
                        <div>
                            <label htmlFor="project-assignee" className="block text-sm font-semibold text-gray-700 mb-1">æŒ‡æ´¾è™•ç†äºº (é¸å¡«)</label>
                            <select
                                id="project-assignee"
                                value={assigneeId}
                                onChange={(e) => setAssigneeId(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                                disabled={isSubmitting}
                            >
                                <option value="">-- æœªæŒ‡æ´¾ (å¯ç¨å¾ŒæŒ‡æ´¾) --</option>
                                {assignees.map((a) => (
                                    <option key={a.id} value={a.id}>
                                        {/* é¡¯ç¤º å§“å (å“¡å·¥ç·¨è™Ÿ) - Email */}
                                        {a.name} ({a.employeeId || 'N/A'}) - {a.email || 'ç„¡ Email'}
                                    </option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="flex justify-end space-x-3 mt-6">
                        <button 
                            type="button" 
                            onClick={onClose} 
                            className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                            disabled={isSubmitting}
                        >
                            å–æ¶ˆ
                        </button>
                        <button 
                            type="submit" 
                            className="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition disabled:bg-green-400"
                            disabled={isSubmitting || !name.trim()}
                        >
                            {isSubmitting ? 'æ–°å¢ä¸­...' : 'ç¢ºèªæ–°å¢å°ˆæ¡ˆ'}
                        </button>
                    </div>
                </form>
            );
        };
        
        /**
         * ç®¡ç†å“¡ï¼šç”¨æˆ¶ç®¡ç†æ¨¡æ…‹æ¡†
         */
        const AdminManagementModal = ({ db, onlineUsers, assignees, onClose, showNotification }) => {
            const [isAdding, setIsAdding] = useState(false);

            // è™•ç†å°‡ç”¨æˆ¶æ–°å¢ç‚º Assignee (ç°¡åŒ–ï¼šè‹¥æœªè¨»å†Šï¼Œä½¿ç”¨åŒ¿åè³‡è¨Š)
            const handleAddAsAssignee = async (user) => {
                const isProfiled = assignees.some(a => a.id === user.id);
                if (isProfiled) {
                    showNotification('warning', `ç”¨æˆ¶ ${user.id.substring(0, 8)} å·²ç¶“æ˜¯è™•ç†äººã€‚`);
                    return;
                }
                
                const newAssigneeData = {
                    id: user.id,
                    name: `Anon User ${user.id.substring(0, 8)}`, 
                    employeeId: 'N/A (åŒ¿å)', 
                    email: `anon.${user.id}@system.com`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                };

                setIsAdding(true);
                try {
                    const docRef = db.collection(ASSIGNEES_PATH).doc(user.id);
                    await docRef.set(newAssigneeData, { merge: true });

                    showNotification('success', `æˆåŠŸå°‡ç”¨æˆ¶ [${newAssigneeData.name}] æ–°å¢ç‚ºè™•ç†äººã€‚`);
                } catch (error) {
                    console.error("æ–°å¢è™•ç†äººå¤±æ•—:", error);
                    showNotification('error', `æ–°å¢è™•ç†äººå¤±æ•—: ${error.message}`);
                } finally {
                    setIsAdding(false);
                }
            };
            
            // è™•ç†åˆªé™¤ç”¨æˆ¶ (åŒæ™‚åˆªé™¤ Assignee Profile)
            const handleDeleteUser = async (userIdToDelete, userName) => {
                if (userIdToDelete === ADMIN_ID) {
                    showNotification('error', 'ç¦æ­¢ï¼šä¸èƒ½åˆªé™¤ç³»çµ±ç®¡ç†å“¡å¸³æˆ¶ã€‚');
                    return;
                }
                if (!window.confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ ${userName} (ID: ${userIdToDelete}) å—ï¼Ÿæ­¤æ“ä½œæœƒåŒæ™‚åˆªé™¤å…¶è™•ç†äººèº«ä»½ï¼`)) {
                    return;
                }

                try {
                    await db.collection(USER_PROFILES_PATH).doc(userIdToDelete).delete();
                    await db.collection(ASSIGNEES_PATH).doc(userIdToDelete).delete();
                    showNotification('success', `æˆåŠŸåˆªé™¤ç”¨æˆ¶å’Œè™•ç†äººèº«ä»½ï¼š${userName}ã€‚`);
                } catch (error) {
                    console.error("åˆªé™¤ç”¨æˆ¶å¤±æ•—:", error);
                    showNotification('error', `åˆªé™¤ç”¨æˆ¶å¤±æ•—: ${error.message}`);
                }
            };


            // ç•¶å‰å·²æ˜¯ Assignee çš„ ID åˆ—è¡¨
            const currentAssigneeIds = useMemo(() => new Set(assignees.map(a => a.id)), [assignees]);

            return (
                <Modal 
                    isOpen={true} 
                    title={`ç®¡ç†å“¡é¢æ¿ (${onlineUsers.length} äººåœ¨ç·š)`}
                    onClose={onClose}
                    className="max-w-3xl"
                >
                    <div className="space-y-6">
                        {/* ç¾æœ‰è™•ç†äºº/è¨»å†Šç”¨æˆ¶åˆ—è¡¨ (å¯åˆªé™¤) */}
                        <div className="border border-gray-200 rounded-xl p-4 bg-white">
                            <h4 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                                <Users className="w-5 h-5 mr-2 text-primary-600" /> ç¾æœ‰è¨»å†Šç”¨æˆ¶èˆ‡è™•ç†äºº ({assignees.length})
                            </h4>
                            <div className="max-h-60 overflow-y-auto pr-2">
                                {assignees.length === 0 ? (
                                    <p className="text-gray-500 italic">ç›®å‰æ²’æœ‰å°ˆæ¡ˆè™•ç†äºº/è¨»å†Šç”¨æˆ¶ã€‚</p>
                                ) : (
                                    <ul className="divide-y divide-gray-100">
                                        {assignees.map((a) => (
                                            <li key={a.id} className="flex justify-between items-center py-2 text-sm">
                                                <div className="flex-1 mr-4">
                                                    <p className="font-medium text-gray-800">{a.name} ({a.employeeId || 'N/A'})</p>
                                                    <p className="text-xs text-gray-500 truncate" title={a.email}>Email: {a.email || 'ç„¡ Email'}</p>
                                                </div>
                                                <button
                                                    onClick={() => handleDeleteUser(a.id, a.name)}
                                                    className="p-2 text-red-600 hover:text-white hover:bg-red-600 rounded-full transition duration-150 disabled:opacity-50"
                                                    disabled={a.id === ADMIN_ID}
                                                    title={a.id === ADMIN_ID ? 'ç„¡æ³•åˆªé™¤ç³»çµ±ç®¡ç†å“¡' : 'åˆªé™¤ç”¨æˆ¶'}
                                                >
                                                    <Trash className="w-5 h-5" />
                                                </button>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>
                        
                        {/* åœ¨ç·šç”¨æˆ¶åˆ—è¡¨ (å¯æ–°å¢ç‚ºè™•ç†äºº) */}
                        <div className="border border-gray-200 rounded-xl p-4 bg-gray-50">
                            <h4 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                                <Users className="w-5 h-5 mr-2 text-teal-600" /> ç•¶å‰åœ¨ç·šä¸”æœªè¨»å†Šç”¨æˆ¶ ({onlineUsers.filter(u => !currentAssigneeIds.has(u.id)).length})
                            </h4>
                            <div className="max-h-60 overflow-y-auto pr-2">
                                {onlineUsers.filter(u => !currentAssigneeIds.has(u.id)).length === 0 ? (
                                    <p className="text-gray-500 italic">æ‰€æœ‰åœ¨ç·šç”¨æˆ¶å‡å·²è¨»å†Š/ç‚ºè™•ç†äººã€‚</p>
                                ) : (
                                    <ul className="divide-y divide-gray-200">
                                        {onlineUsers.filter(u => !currentAssigneeIds.has(u.id)).map((user) => (
                                            <li key={user.id} className="flex justify-between items-center py-2 text-sm">
                                                <div className="flex-1 mr-4">
                                                    <p className="font-mono text-gray-800 break-all">{user.id.substring(0, 16)}...</p>
                                                    <p className="text-xs text-gray-500">æœ€å¾Œæ´»èº: {user.lastSeen.toLocaleTimeString()}</p>
                                                </div>
                                                
                                                <button
                                                    onClick={() => handleAddAsAssignee(user)}
                                                    className="px-3 py-1 text-xs font-medium text-white bg-teal-500 rounded-lg shadow-sm hover:bg-teal-600 transition disabled:opacity-50"
                                                    disabled={isAdding}
                                                >
                                                    {isAdding ? 'æ–°å¢ä¸­...' : 'æ–°å¢ç‚ºè™•ç†äºº'}
                                                </button>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>


                        <div className="flex justify-end mt-4">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                            >
                                é—œé–‰ç®¡ç†é¢æ¿
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };


        // ----------------------------------------------------------------------
        // 3. MAIN APPLICATION COMPONENT
        // ----------------------------------------------------------------------

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [projects, setProjects] = useState([]);
            const [assignees, setAssignees] = useState([]);
            const [presenceData, setPresenceData] = useState([]); 
            const [userId, setUserId] = useState(null); 
            // ** ç”¨æˆ¶è³‡æ–™ç‹€æ…‹ **
            const [userProfile, setUserProfile] = useState(null);
            const [isRegistered, setIsRegistered] = useState(false); // æ˜¯å¦å·²è¨»å†Šå€‹äººè³‡æ–™
            
            const [loading, setLoading] = useState(true); 
            const [isDbConnected, setIsDbConnected] = useState(true);

            // é€šçŸ¥å’Œæ¨¡æ…‹æ¡†ç‹€æ…‹
            const [notification, setNotification] = useState({ visible: false, type: 'success', message: '' });
            const [emailModalConfig, setEmailModalConfig] = useState({});
            const [assigneeModalConfig, setAssigneeModalConfig] = useState({});
            const [addProjectModalOpen, setAddProjectModalOpen] = useState(false); 
            const [adminManagementModalOpen, setAdminManagementModalOpen] = useState(false);
            const [registrationModalOpen, setRegistrationModalOpen] = useState(false);


            // é¡¯ç¤ºé€šçŸ¥çš„ useCallback
            const showNotification = useCallback((type, message) => {
                setNotification({ visible: true, type, message });
                setTimeout(() => {
                    setNotification({ visible: false, type, message: '' });
                }, 4000);
            }, []);

            // é–‹å•Ÿéƒµä»¶é€šçŸ¥æ¨¡æ…‹æ¡†
            const openEmailModal = (to, subject, body, isVerification = false) => {
                setEmailModalConfig({
                    isOpen: true,
                    emailContent: { to, subject, body },
                    isVerification
                });
            };
            
            // è™•ç†è¨»å†ŠæˆåŠŸçš„å›èª¿å‡½æ•¸
            const handleRegistrationSuccess = useCallback((profile) => {
                setUserProfile(profile);
                setIsRegistered(true);
                setRegistrationModalOpen(false);
                // è¨»å†ŠæˆåŠŸå¾Œä¸è‡ªå‹•é–‹å•Ÿæ–°å¢å°ˆæ¡ˆè¡¨å–®ï¼Œè®“ç”¨æˆ¶å…ˆè™•ç†é©—è­‰ä¿¡
                // setAddProjectModalOpen(true); 
            }, []);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
            const canManage = userId === ADMIN_ID;

            // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç·¨è¼¯å°ˆæ¡ˆ (åŒ…å«ç‹€æ…‹å’Œè½‰äº¤)
            const canEditProject = useCallback((project) => {
                return canManage || (userId && userId === project.assigneeId);
            }, [canManage, userId]);


            // 1. Firebase åˆå§‹åŒ–èˆ‡ç™»å…¥
            useEffect(() => {
                const runInitialization = async () => {
                    try {
                        const { db: initializedDb, auth: initializedAuth, userId: authenticatedUserId } = await initFirebase();

                        if (authenticatedUserId === 'ERROR' || !initializedDb) {
                             setUserId('ERROR');
                             setIsDbConnected(false);
                        } else {
                            setDb(initializedDb);
                            setAuth(initializedAuth);
                            setUserId(authenticatedUserId); 
                            setIsDbConnected(true);
                            
                            const profileRef = initializedDb.collection(USER_PROFILES_PATH).doc(authenticatedUserId);
                            const profileSnap = await profileRef.get();
                            
                            const isAdmin = authenticatedUserId === ADMIN_ID;

                            if (isAdmin) {
                                // ** ç®¡ç†å“¡å…è¨»å†Šé‚è¼¯ **
                                setIsRegistered(true);
                                // å¦‚æœç®¡ç†å“¡ Profile ä¸å­˜åœ¨ï¼Œå‰‡è‡ªå‹•å‰µå»ºä¸€å€‹ Mock Profile
                                if (!profileSnap.exists) {
                                    const mockAdminProfile = {
                                        name: 'ç³»çµ±ç®¡ç†å“¡',
                                        employeeId: 'ADMIN001',
                                        email: ADMIN_EMAIL, 
                                        userId: authenticatedUserId,
                                        isVerified: true,
                                        registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    };
                                    await profileRef.set(mockAdminProfile, { merge: true });
                                    setUserProfile(mockAdminProfile);
                                    
                                    // åŒæ­¥æ–°å¢åˆ° Assignees
                                    await initializedDb.collection(ASSIGNEES_PATH).doc(authenticatedUserId).set({
                                        id: authenticatedUserId,
                                        name: 'ç³»çµ±ç®¡ç†å“¡',
                                        employeeId: 'ADMIN001',
                                        email: ADMIN_EMAIL,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    }, { merge: true });
                                } else {
                                    setUserProfile(profileSnap.data());
                                }
                                console.log(`[Auth] User is System Admin (${authenticatedUserId}). Registration bypassed.`);
                            } else if (profileSnap.exists) {
                                // Regular user found
                                const profile = profileSnap.data();
                                setUserProfile(profile);
                                setIsRegistered(true);
                                console.log(`[Auth] User ${profile.name} is registered.`);
                            } else {
                                // Regular user not found, must register
                                setIsRegistered(false);
                                setRegistrationModalOpen(true); // é–‹å•Ÿè¨»å†Šæ¨¡æ…‹æ¡†
                                console.log(`[Auth] User ${authenticatedUserId} is NOT registered. Opening registration.`);
                            }
                        }
                    } catch (error) {
                        console.error("Initialization failed outside try/catch:", error);
                        setUserId('ERROR');
                        setIsDbConnected(false);
                    } finally {
                        setLoading(false); 
                    }
                };

                runInitialization();
            }, []); 
            
            // 2. ç›£è½è³‡æ–™åº« (Projects & Assignees)
            useEffect(() => {
                if (!db || userId === null || userId === 'ERROR') return; 

                console.log("Starting Firestore Listeners...");

                // å°ˆæ¡ˆè³‡æ–™ç›£è½
                const unsubscribeProjects = db.collection(PROJECTS_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjects(data);
                    setIsDbConnected(true);
                }, (error) => {
                    console.error("Error fetching projects: ", error);
                    setIsDbConnected(false);
                    showNotification('error', 'ç„¡æ³•è¼‰å…¥å°ˆæ¡ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥ Firebase é€£ç·šæˆ–æ¬Šé™ã€‚');
                });
                
                // è™•ç†äººè³‡æ–™ç›£è½
                const unsubscribeAssignees = db.collection(ASSIGNEES_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAssignees(data);
                }, (error) => {
                    console.error("Error fetching assignees: ", error);
                });

                return () => {
                    unsubscribeProjects();
                    unsubscribeAssignees();
                };
            }, [db, userId, showNotification]);
            
            // 3. å¯¦ä½œåœ¨ç·šç‹€æ…‹è¿½è¹¤ç³»çµ± (Presence System)
            useEffect(() => {
                if (!db || userId === null || userId === 'ERROR') return;

                const presenceRef = db.collection(PRESENCE_PATH).doc(userId);
                
                const updatePresence = () => {
                    presenceRef.set({
                        userId: userId,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    }, { merge: true }).catch(err => console.error("Failed to update presence:", err));
                };

                updatePresence(); // åˆå§‹æ›´æ–°
                
                const intervalId = setInterval(updatePresence, 30000); 

                // ç›£è½ Presence è³‡æ–™
                const unsubscribePresence = db.collection(PRESENCE_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPresenceData(data);
                }, (error) => {
                    console.error("Error fetching presence data: ", error);
                });

                return () => {
                    clearInterval(intervalId); // æ¸…é™¤å®šæ™‚å™¨
                    unsubscribePresence(); // åœæ­¢ç›£è½
                };
            }, [db, userId]); 
            
            // ç²å–è™•ç†äººå§“åçš„ Helper
            const getAssigneeDisplayInfo = useCallback((assigneeId) => {
                const assignee = assignees.find(a => a.id === assigneeId);
                
                if (assignee) {
                    const name = assignee.name || 'æœªçŸ¥å§“å';
                    const email = assignee.email || 'ç„¡ Email';
                    return {
                        name: name,
                        email: email,
                        displayName: `${name} (${assignee.employeeId || 'N/A'})`
                    };
                }
                
                return {
                    name: 'æœªæŒ‡æ´¾',
                    email: 'N/A',
                    displayName: 'æœªæŒ‡æ´¾'
                };
            }, [assignees]);
            
            
            // æª¢æŸ¥æ˜¯å¦å¯ä»¥æ–°å¢å°ˆæ¡ˆ (å·²é€£ç·šä¸”å·²è¨»å†Š/ç‚ºç®¡ç†å“¡)
            const canAddProject = isDbConnected && isRegistered && !loading;

            // è™•ç†é»æ“Šã€Œæ–°å¢å°ˆæ¡ˆã€æŒ‰éˆ•
            const handleAddProjectClick = () => {
                if (!isRegistered) {
                    setRegistrationModalOpen(true);
                } else {
                    setAddProjectModalOpen(true);
                }
            };


            // ** è¨ˆç®—ç•¶å‰åœ¨ç·šç”¨æˆ¶ **
            const onlineUsers = useMemo(() => {
                const threshold = Date.now() - 60000; 
                return presenceData
                    .filter(p => p.lastSeen && p.lastSeen.toDate().getTime() > threshold)
                    .map(p => ({
                        id: p.userId || p.id,
                        lastSeen: p.lastSeen.toDate(),
                    }));
            }, [presenceData]);

            // ** è™•ç†å°ˆæ¡ˆç‹€æ…‹æ›´æ–°é‚è¼¯ **
            const handleUpdateStatus = async (projectId, newStatus, projectName) => {
                if (!db || !projectId) return;

                const project = projects.find(p => p.id === projectId);
                if (!project || !canEditProject(project)) {
                    showNotification('error', 'æ‚¨æ²’æœ‰æ¬Šé™æ›´æ”¹æ­¤å°ˆæ¡ˆçš„ç‹€æ…‹ã€‚');
                    return;
                }

                try {
                    const projectRef = db.collection(PROJECTS_PATH).doc(projectId);
                    await projectRef.update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('success', `å°ˆæ¡ˆ [${projectName}] ç‹€æ…‹å·²æ›´æ–°ç‚º [${newStatus}]ã€‚`);

                } catch (error) {
                    console.error("æ›´æ–°å°ˆæ¡ˆç‹€æ…‹å¤±æ•—:", error);
                    showNotification('error', `æ›´æ–°å°ˆæ¡ˆç‹€æ…‹å¤±æ•—: ${error.message}`);
                }
            };
            
            // ** è™•ç†å°ˆæ¡ˆåˆªé™¤é‚è¼¯ **
            const handleDeleteProject = async (projectId, projectName) => {
                if (!db || !canManage) {
                    showNotification('error', 'åªæœ‰ç®¡ç†å“¡æœ‰æ¬Šé™åˆªé™¤å°ˆæ¡ˆã€‚');
                    return;
                }
                if (!window.confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å°ˆæ¡ˆï¼š"${projectName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                    return;
                }

                try {
                    await db.collection(PROJECTS_PATH).doc(projectId).delete();
                    showNotification('success', `æˆåŠŸåˆªé™¤å°ˆæ¡ˆï¼š[${projectName}]ã€‚`);
                } catch (error) {
                    console.error("åˆªé™¤å°ˆæ¡ˆå¤±æ•—:", error);
                    showNotification('error', `åˆªé™¤å°ˆæ¡ˆå¤±æ•—: ${error.message}`);
                }
            };

            // ** è™•ç†æ›´æ›è™•ç†äººé‚è¼¯ (æ›´æ–°æ¨¡æ“¬ Email é€šçŸ¥) **
            const handleUpdateAssignee = async (projectId, newAssigneeId, projectName) => {
                if (!db || !projectId) return;

                const project = projects.find(p => p.id === projectId);
                if (!project || !canEditProject(project)) {
                    showNotification('error', 'æ‚¨æ²’æœ‰æ¬Šé™è½‰äº¤æ­¤å°ˆæ¡ˆã€‚');
                    setAssigneeModalConfig({ isOpen: false });
                    return;
                }

                const currentAssigneeInfo = getAssigneeDisplayInfo(project.assigneeId);
                const newAssigneeInfo = getAssigneeDisplayInfo(newAssigneeId);
                
                // æª¢æŸ¥æ˜¯å¦æ²’æœ‰è®ŠåŒ–
                if (newAssigneeId === project.assigneeId) {
                    showNotification('warning', 'è™•ç†äººæ²’æœ‰æ”¹è®Šã€‚');
                    setAssigneeModalConfig({ isOpen: false });
                    return;
                }

                try {
                    const projectRef = db.collection(PROJECTS_PATH).doc(projectId);
                    await projectRef.update({
                        assigneeId: newAssigneeId,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('success', `å°ˆæ¡ˆ [${projectName}] æˆåŠŸè½‰äº¤çµ¦ ${newAssigneeInfo.displayName}ã€‚`);
                    
                    // æ¨¡æ“¬ç™¼é€é€šçŸ¥
                    if (newAssigneeId && newAssigneeInfo.email && newAssigneeInfo.email !== 'N/A') {
                        const emailBody = `
æ‚¨å¥½ ${newAssigneeInfo.name},

æ‚¨å·²è¢«æŒ‡æ´¾ç‚ºæ–°çš„å°ˆæ¡ˆè™•ç†äººã€‚
å°ˆæ¡ˆåç¨±: ${projectName}
å‰ä»»è™•ç†äºº: ${currentAssigneeInfo.name}
è«‹æª¢æŸ¥å„€è¡¨æ¿ä»¥é–‹å§‹å·¥ä½œã€‚
`;
                        // ä½¿ç”¨æ–°çš„è™•ç†äºº Email
                        openEmailModal(newAssigneeInfo.email, `[Action Required] æ–°å°ˆæ¡ˆæŒ‡æ´¾: ${projectName}`, emailBody.trim());
                    }

                } catch (error) {
                    console.error("æ›´æ–°è™•ç†äººå¤±æ•—:", error);
                    showNotification('error', `æ›´æ–°è™•ç†äººå¤±æ•—: ${error.message}`);
                } finally {
                    setAssigneeModalConfig({ isOpen: false });
                }
            };
            
            // æ›´æ›è™•ç†äººè¡¨å–® (ç”¨æ–¼ Modal)
            const AssigneeChangeForm = () => {
                const project = projects.find(p => p.id === assigneeModalConfig.projectId);
                if (!project) return null;

                const [selectedAssigneeId, setSelectedAssigneeId] = useState(project.assigneeId || '');
                const currentAssigneeInfo = getAssigneeDisplayInfo(project.assigneeId);

                const onSubmit = (e) => {
                    e.preventDefault();
                    handleUpdateAssignee(
                        project.id,
                        selectedAssigneeId,
                        project.name
                    );
                };

                return (
                    <form onSubmit={onSubmit}>
                        <p className="text-sm text-gray-700 mb-4">
                            æ‚¨æ­£åœ¨ç‚ºå°ˆæ¡ˆ **{project.name}** è½‰äº¤è™•ç†äººã€‚
                            ç•¶å‰è™•ç†äºº: **{currentAssigneeInfo.displayName}**
                        </p>
                        
                        <label htmlFor="new-assignee" className="block text-sm font-semibold text-gray-700 mb-1">é¸æ“‡æ–°çš„è™•ç†äºº</label>
                        <select
                            id="new-assignee"
                            value={selectedAssigneeId}
                            onChange={(e) => setSelectedAssigneeId(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition shadow-sm"
                        >
                            <option value="">-- æœªæŒ‡æ´¾ --</option>
                            {assignees.map((a) => (
                                <option key={a.id} value={a.id}>
                                    {/* é¡¯ç¤º å§“å (å“¡å·¥ç·¨è™Ÿ) - Email */}
                                    {a.name} ({a.employeeId || 'N/A'}) - {a.email || 'ç„¡ Email'}
                                </option>
                            ))}
                        </select>
                        
                        <div className="flex justify-end space-x-3 mt-6">
                            <button 
                                type="button" 
                                onClick={() => setAssigneeModalConfig({ isOpen: false })} 
                                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                            >
                                å–æ¶ˆ
                            </button>
                            <button 
                                type="submit" 
                                className="px-4 py-2 text-sm font-medium text-white bg-primary-500 rounded-lg shadow-md hover:bg-primary-600 transition"
                                disabled={selectedAssigneeId === project.assigneeId}
                            >
                                ç¢ºèªè½‰äº¤
                            </button>
                        </div>
                    </form>
                );
            };

            // ä¸»è¦å„€è¡¨æ¿å…§å®¹
            const DashboardContent = useMemo(() => {
                if (loading) {
                    return (
                        <div className="text-center py-20 text-gray-500">
                            <svg className="animate-spin h-8 w-8 text-primary-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p>æ­£åœ¨é€£ç·šè‡³å„€è¡¨æ¿è³‡æ–™...</p>
                        </div>
                    );
                }
                
                if (userId === 'ERROR') {
                    return (
                        <div className="text-center py-20 bg-red-100 rounded-xl border border-red-300 text-red-700">
                            <AlertTriangle className="w-10 h-10 mx-auto mb-4" />
                            <h2 className="text-xl font-bold">é€£ç·šéŒ¯èª¤</h2>
                            <p className="mt-2">ç„¡æ³•é€£ç·šåˆ° Firebase è³‡æ–™åº«ã€‚è«‹æª¢æŸ¥æ‚¨çš„é€£ç·šç‹€æ…‹æˆ–æ‡‰ç”¨ç¨‹å¼é…ç½®ã€‚</p>
                        </div>
                    );
                }
                
                if (!userId) {
                    return <div className="text-center py-20 text-gray-500">æ­£åœ¨ç­‰å¾…ç”¨æˆ¶èº«ä»½é©—è­‰...</div>;
                }


                return (
                    <div className="bg-white shadow-xl rounded-xl mt-8 overflow-hidden border border-gray-100">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-2/5">å°ˆæ¡ˆåç¨±</th>
                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/5">ç‹€æ…‹</th>
                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/5">è™•ç†äºº</th>
                                    <th className="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/5">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-100">
                                {projects.length === 0 ? (
                                    <tr>
                                        <td colSpan="4" className="px-6 py-10 whitespace-nowrap text-lg text-gray-400 text-center">
                                            ğŸ‰ æ­å–œï¼Œç›®å‰æ²’æœ‰å¾…è™•ç†çš„å°ˆæ¡ˆï¼
                                            <p className="text-sm mt-2">é»æ“Šä¸Šæ–¹ "æ–°å¢å°ˆæ¡ˆ" æŒ‰éˆ•ä¾†é–‹å§‹ä¸€å€‹æ–°ä»»å‹™ã€‚</p>
                                        </td>
                                    </tr>
                                ) : (
                                    projects.map((project) => {
                                        // ** æª¢æŸ¥æ˜¯å¦å¯ä»¥ç·¨è¼¯ (ç‹€æ…‹æˆ–æŒ‡æ´¾äºº) **
                                        const canChange = canEditProject(project);
                                        const assigneeInfo = getAssigneeDisplayInfo(project.assigneeId);

                                        return (
                                            <tr key={project.id} className="hover:bg-gray-50 transition duration-150">
                                                <td className="px-6 py-4 text-sm font-medium text-gray-900 flex justify-between items-center">
                                                    <span>{project.name}</span>
                                                    {/* å°ˆæ¡ˆåˆªé™¤æŒ‰éˆ• (åƒ…é™ç®¡ç†å“¡) */}
                                                    {canManage && (
                                                        <button
                                                            onClick={() => handleDeleteProject(project.id, project.name)}
                                                            className="p-1 text-red-500 hover:text-white hover:bg-red-500 rounded-full transition ml-4"
                                                            title="ç®¡ç†å“¡ï¼šåˆªé™¤å°ˆæ¡ˆ"
                                                        >
                                                            <Trash className="w-4 h-4" />
                                                        </button>
                                                    )}
                                                </td>
                                                
                                                {/* ** å°ˆæ¡ˆç‹€æ…‹æ¬„ä½ (ä¸‹æ‹‰é¸å–®/åªè®€) ** */}
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    {canChange ? (
                                                        <select
                                                            value={project.status}
                                                            onChange={(e) => handleUpdateStatus(project.id, e.target.value, project.name)}
                                                            className="py-1 px-2 border border-gray-300 rounded-lg text-sm shadow-sm focus:ring-primary-500 focus:border-primary-500 transition disabled:opacity-50"
                                                            aria-label={`Change status for ${project.name}`}
                                                            disabled={!db}
                                                        >
                                                            {STATUS_OPTIONS.map((s) => (
                                                                <option key={s} value={s}>{s}</option>
                                                            ))}
                                                        </select>
                                                    ) : (
                                                        <StatusBadge status={project.status} />
                                                    )}
                                                </td>
                                                
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600" title={assigneeInfo.email}>{assigneeInfo.displayName}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button
                                                        onClick={() => setAssigneeModalConfig({
                                                            isOpen: true,
                                                            projectId: project.id,
                                                            projectName: project.name,
                                                        })}
                                                        className="inline-flex items-center px-4 py-2 border border-primary-300 rounded-lg shadow-sm text-sm font-medium text-primary-700 bg-primary-50 hover:bg-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition disabled:opacity-50"
                                                        disabled={!db || !canChange} // ç®¡ç†å“¡æˆ–æŒ‡æ´¾äººå¯ä»¥è½‰äº¤
                                                        title={canChange ? "è½‰äº¤è™•ç†äºº" : "æ‚¨æ²’æœ‰æ¬Šé™è½‰äº¤"}
                                                    >
                                                        <Users className="w-4 h-4 mr-2" /> è½‰äº¤è™•ç†äºº
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>
                );
            }, [projects, loading, userId, getAssigneeDisplayInfo, canManage, isDbConnected, handleUpdateStatus, canEditProject, handleDeleteProject]); 

            return (
                <div className="min-h-screen p-4 sm:p-6 lg:p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header and Status */}
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-6 border-b border-gray-200">
                            <h1 className="text-4xl font-extrabold text-gray-900 mb-4 sm:mb-0">
                                å°ˆæ¡ˆé‹ç‡Ÿå„€è¡¨æ¿
                            </h1>
                            <div className="flex items-center space-x-3">
                                {/* æ–°å¢å°ˆæ¡ˆæŒ‰éˆ• */}
                                {(userId && userId !== 'ERROR' && !loading) && (
                                    <button 
                                        onClick={handleAddProjectClick}
                                        className={`inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-md text-white transition ${canAddProject ? 'bg-green-600 hover:bg-green-700 focus:ring-green-500' : 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-500'}`}
                                        disabled={!db}
                                        title={canAddProject ? 'æ–°å¢ä¸€å€‹æ–°å°ˆæ¡ˆ' : 'é»æ“Šè¨»å†Šä»¥æ–°å¢å°ˆæ¡ˆ'}
                                    >
                                        {canAddProject ? (
                                            <PlusCircle className="w-5 h-5 mr-2" />
                                        ) : (
                                            <UserCheck className="w-5 h-5 mr-2" />
                                        )}
                                        {canAddProject ? 'æ–°å¢å°ˆæ¡ˆ' : 'è¨»å†Šå¾Œæ–°å¢'}
                                    </button>
                                )}
                                
                                {/* ç®¡ç†é¢æ¿æŒ‰éˆ• (åƒ…é™ç®¡ç†å“¡) */}
                                {canManage && (
                                    <button 
                                        onClick={() => setAdminManagementModalOpen(true)}
                                        className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-md text-white bg-teal-500 hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition"
                                        disabled={!db}
                                    >
                                        <Settings className="w-5 h-5 mr-2" /> ç®¡ç†å“¡é¢æ¿
                                    </button>
                                )}
                                

                                <div className="flex items-center space-x-3 bg-white p-3 rounded-xl shadow-md">
                                    {/* åœ¨ç·šç”¨æˆ¶è¨ˆæ•¸ */}
                                    <div className="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 flex items-center">
                                        <Users className="w-3 h-3 mr-1" /> åœ¨ç·šäººæ•¸: {onlineUsers.length}
                                    </div>
                                    {/* è§’è‰²ç‹€æ…‹ */}
                                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${canManage ? 'bg-indigo-100 text-indigo-700' : (isRegistered ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700')}`}>
                                        {canManage ? 'ğŸ‘‘ ç®¡ç†å“¡' : (isRegistered ? `ğŸ‘¤ ${userProfile?.name || 'å·²è¨»å†Šç”¨æˆ¶'}` : 'ğŸš« æœªè¨»å†Š')}
                                    </div>
                                    {/* DB é€£ç·šç‹€æ…‹ */}
                                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${isDbConnected ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        {isDbConnected ? 'ğŸŸ¢ DB é€£ç·šæ­£å¸¸' : 'ğŸ”´ DB é€£ç·šä¸­æ–·'}
                                    </div>
                                    {/* ç”¨æˆ¶ ID */}
                                    <div className="text-xs text-gray-600 truncate">
                                        ç”¨æˆ¶ ID: <span className="font-mono text-gray-800">{loading ? 'é€£ç·šä¸­...' : userId}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Notification Banner */}
                        {notification.visible && (
                            <div className={`mt-6 p-4 rounded-lg flex items-center shadow-lg ${notification.type === 'success' ? 'bg-green-50 text-green-700 border-l-4 border-green-400' : 'bg-red-50 text-red-700 border-l-4 border-red-400'}`}>
                                {notification.type === 'success' ? <CheckCircle className="w-5 h-5 mr-3" /> : <XCircle className="w-5 h-5 mr-3" />}
                                <p className="text-sm font-medium">{notification.message}</p>
                            </div>
                        )}

                        {/* Project List */}
                        {DashboardContent}
                        
                        {/* Modals */}

                        {/* 1. æ¨¡æ“¬éƒµä»¶é€šçŸ¥æ¨¡æ…‹æ¡† (åŒ…å«é©—è­‰ä¿¡æç¤º) */}
                        <EmailNotificationModal
                            isOpen={emailModalConfig.isOpen}
                            emailContent={emailModalConfig.emailContent}
                            isVerification={emailModalConfig.isVerification}
                            onClose={() => setEmailModalConfig({ isOpen: false })}
                        />
                        
                        {/* 2. æ›´æ›è™•ç†äººæ¨¡æ…‹æ¡† */}
                        <Modal
                            isOpen={assigneeModalConfig.isOpen}
                            title={`è½‰äº¤å°ˆæ¡ˆ: ${projects.find(p => p.id === assigneeModalConfig.projectId)?.name || ''}`}
                            onClose={() => setAssigneeModalConfig({ isOpen: false })}
                        >
                            {db && assigneeModalConfig.isOpen && <AssigneeChangeForm />}
                        </Modal>
                        
                        {/* 3. ç”¨æˆ¶è¨»å†Šæ¨¡æ…‹æ¡† (éç®¡ç†å“¡ç”¨æˆ¶) */}
                        {db && userId && registrationModalOpen && !canManage && (
                            <UserRegistrationModal
                                db={db}
                                userId={userId}
                                onRegistrationSuccess={handleRegistrationSuccess}
                                showNotification={showNotification}
                                onClose={() => setRegistrationModalOpen(false)} 
                                openEmailModal={openEmailModal}
                            />
                        )}


                        {/* 4. æ–°å¢å°ˆæ¡ˆæ¨¡æ…‹æ¡† - åªæœ‰å·²è¨»å†Š/ç®¡ç†å“¡çš„ç”¨æˆ¶æ‰èƒ½çœ‹åˆ°ä¸¦ä½¿ç”¨ */}
                        <Modal
                            isOpen={addProjectModalOpen}
                            title="æ–°å¢å°ˆæ¡ˆ" 
                            onClose={() => setAddProjectModalOpen(false)}
                        >
                            {db && isRegistered && (
                                <AddProjectForm
                                    db={db}
                                    assignees={assignees}
                                    onClose={() => setAddProjectModalOpen(false)}
                                    showNotification={showNotification}
                                />
                            )}
                        </Modal>
                        
                        {/* 5. ç®¡ç†å“¡é¢æ¿æ¨¡æ…‹æ¡† (åƒ…é™ç®¡ç†å“¡å¯è¦‹) */}
                        {canManage && db && adminManagementModalOpen && ( 
                            <AdminManagementModal
                                db={db}
                                onlineUsers={onlineUsers}
                                assignees={assignees}
                                onClose={() => setAdminManagementModalOpen(false)}
                                showNotification={showNotification}
                            />
                        )}

                    </div>
                </div>
            );
        };

        // ç¢ºä¿ DOM è¼‰å…¥å®Œæˆå¾Œå†æ¸²æŸ“
        window.onload = () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            } else {
                console.error("ç„¡æ³•æ‰¾åˆ° #root å…ƒç´ ");
            }
        };
    </script>
</body>
</html>

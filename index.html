<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script> 
    
    <style>
        /* 確保全螢幕高度和背景 */
        body, #root {
            height: 100vh;
            margin: 0;
            background-color: #f7f8fa; /* 淺灰背景 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { RefreshCw, Users, Send, CheckCircle, XCircle } = lucide; 
        
        // ----------------------------------------------------------------------
        // 1. CONSTANTS
        // ----------------------------------------------------------------------
        
        const PROJECTS_PATH = 'projects';
        const ASSIGNEES_PATH = 'assignees';
        const CONFIG_PATH = 'config';
        
        // ----------------------------------------------------------------------
        // 2. FIREBASE INITIALIZATION AND SETUP FOR CANVAS/VERCEL HYBRID
        // ----------------------------------------------------------------------
        
        // ** 修正: 檢查 Canvas 全局變數 '__firebase_config'，如果不存在，則使用 Vercel 環境變數 **
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                // Vercel Fallback Configuration - 讀取 Vercel/本地環境變數
                // 注意：您必須在 Vercel 或本地 .env 檔案中設定 REACT_APP_FIREBASE_... 變數
                apiKey: process.env.REACT_APP_FIREBASE_API_KEY, 
                authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
                projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
                storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,
                messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,
                appId: process.env.REACT_APP_FIREBASE_APP_ID,
                measurementId: process.env.REACT_APP_FIREBASE_MEASUREMENT_ID,
            };

        let app;
        let db;
        let authInstance;
        
        const initFirebase = async () => {
            try {
                // 檢查是否已經初始化
                if (app) {
                    return { db, authInstance };
                }
                
                app = firebase.initializeApp(firebaseConfig);
                authInstance = firebase.auth(app);
                db = firebase.firestore(app);
                
                console.log("Firebase 應用程式初始化成功。");

                // 註冊認證狀態變更監聽器
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        console.log("使用者已登入，UID:", user.uid);
                    } else {
                        console.log("使用者已登出或未登入。");
                    }
                });

                // 處理 Canvas Custom Token 或匿名登入
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (token) {
                    await authInstance.signInWithCustomToken(token);
                    console.log("Signed in with Custom Token.");
                } else {
                    // 備用：如果沒有 Custom Token (Vercel/本地運行)，則使用匿名登入
                    await authInstance.signInAnonymously();
                    console.log("Signed in anonymously (Fallback).");
                }
                
                return { db, authInstance };
            } catch (error) {
                // ** 此處會捕捉到 auth/api-key-not-valid 錯誤 **
                console.error("匿名登入失敗。 Firestore 將無法存取公共資料。錯誤:", error);
                return { db: null, authInstance: null };
            }
        };

        // ----------------------------------------------------------------------
        // 3. UI COMPONENTS
        // ----------------------------------------------------------------------
        
        // 模態框組件
        const Modal = ({ isOpen, title, children, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
                        <div className="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div>
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // 處理人更換表單
        const AssigneeChangeForm = ({ db, projectId, projectName, currentAssigneeId, assignees, onClose, showNotification, openEmailModal }) => {
            const [selectedAssigneeId, setSelectedAssigneeId] = useState(currentAssigneeId);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                
                try {
                    const projectRef = db.collection(PROJECTS_PATH).doc(projectId);
                    await projectRef.update({
                        assigneeId: selectedAssigneeId,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });

                    // 尋找舊的處理人和新的處理人名字
                    const newAssignee = assignees.find(a => a.id === selectedAssigneeId) || { name: '未知' };
                    const oldAssignee = assignees.find(a => a.id === currentAssigneeId) || { name: '未知' };

                    showNotification('success', `成功將專案 [${projectName}] 的處理人從 ${oldAssignee.name} 更換為 ${newAssignee.name}。`);
                    
                    // 打開郵件確認模態框
                    const newAssigneeEmail = newAssignee.email || '';
                    openEmailModal(
                        newAssigneeEmail, 
                        `【專案轉移通知】您現在是專案 [${projectName}] 的處理人`,
                        `您好 ${newAssignee.name},\n\n專案 [${projectName}] 已於 ${new Date().toLocaleString()} 轉交給您處理。\n\n原處理人：${oldAssignee.name}\n\n請登入儀表板查看詳情並開始處理。\n\n謝謝!`
                    );

                    onClose();
                } catch (error) {
                    console.error("更新處理人失敗:", error);
                    showNotification('error', '更新處理人失敗。請查看 Console 獲取詳細資訊。');
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            // 找到當前處理人的名字
            const currentAssignee = assignees.find(a => a.id === currentAssigneeId)?.name || 'N/A';
            
            return (
                <form onSubmit={handleSubmit}>
                    <p className="mb-4 text-sm text-gray-600">
                        目前專案 **{projectName}** 的處理人是: **{currentAssignee}**
                    </p>
                    <div className="mb-4">
                        <label htmlFor="assignee-select" className="block text-sm font-medium text-gray-700 mb-2">選擇新的處理人</label>
                        <select
                            id="assignee-select"
                            value={selectedAssigneeId}
                            onChange={(e) => setSelectedAssigneeId(e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            required
                            disabled={isSubmitting}
                        >
                            <option value="">-- 請選擇 --</option>
                            {assignees.map((a) => (
                                <option key={a.id} value={a.id}>{a.name} ({a.email})</option>
                            ))}
                        </select>
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button 
                            type="button" 
                            onClick={onClose} 
                            className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition"
                            disabled={isSubmitting}
                        >
                            取消
                        </button>
                        <button 
                            type="submit" 
                            className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition disabled:bg-blue-400"
                            disabled={isSubmitting || selectedAssigneeId === currentAssigneeId}
                        >
                            {isSubmitting ? '更換中...' : '確認更換'}
                        </button>
                    </div>
                </form>
            );
        };


        // ----------------------------------------------------------------------
        // 4. MAIN APPLICATION COMPONENT
        // ----------------------------------------------------------------------

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [projects, setProjects] = useState([]);
            const [assignees, setAssignees] = useState([]);
            const [config, setConfig] = useState({});
            const [userId, setUserId] = useState('N/A');
            const [isAdmin, setIsAdmin] = useState(false);
            const [isDbConnected, setIsDbConnected] = useState(true);
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState({ visible: false, type: 'success', message: '' });

            // 模態框狀態
            const [notificationModalConfig, setNotificationModalConfig] = useState({
                isOpen: false,
                emailContent: { to: '', subject: '', body: '' }
            });
            const [assigneeModalConfig, setAssigneeModalConfig] = useState({
                isOpen: false,
                projectId: null,
                projectName: '',
                currentAssigneeId: null,
            });

            // 顯示通知訊息
            const showNotification = useCallback((type, message) => {
                setNotification({ visible: true, type, message });
                setTimeout(() => {
                    setNotification({ visible: false, type, message: '' });
                }, 4000);
            }, []);

            // 打開郵件模態框
            const openEmailModal = (to, subject, body) => {
                setNotificationModalConfig({
                    isOpen: true,
                    emailContent: { to, subject, body }
                });
            };

            // 初始化 Firebase 和登入
            useEffect(() => {
                initFirebase().then(({ db: initializedDb, auth: initializedAuth }) => {
                    setDb(initializedDb);
                    setAuth(initializedAuth);
                    setLoading(false);
                });
            }, []);
            
            // 監聽使用者認證狀態
            useEffect(() => {
                if (auth) {
                    const unsubscribeAuth = auth.onAuthStateChanged(user => {
                        if (user) {
                            setUserId(user.uid);
                            // 簡單判斷：如果是特定 UID 則設為管理員 (應在後端判斷)
                            setIsAdmin(user.uid === 'YOUR_ADMIN_UID'); 
                        } else {
                            setUserId('N/A');
                            setIsAdmin(false);
                        }
                    });
                    return () => unsubscribeAuth();
                }
            }, [auth]);

            // 監聽 Firestore 資料
            useEffect(() => {
                if (!db) return;

                const unsubscribeProjects = db.collection(PROJECTS_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProjects(data);
                    setIsDbConnected(true);
                }, (error) => {
                    console.error("Error fetching projects: ", error);
                    setIsDbConnected(false);
                    showNotification('error', '無法載入專案資料，請檢查 Firebase 連線或權限。');
                });
                
                const unsubscribeAssignees = db.collection(ASSIGNEES_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAssignees(data);
                }, (error) => {
                    console.error("Error fetching assignees: ", error);
                });

                const unsubscribeConfig = db.collection(CONFIG_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.reduce((acc, doc) => ({ ...acc, [doc.id]: doc.data() }), {});
                    setConfig(data);
                }, (error) => {
                    console.error("Error fetching config: ", error);
                });

                return () => {
                    unsubscribeProjects();
                    unsubscribeAssignees();
                    unsubscribeConfig();
                };
            }, [db, showNotification]);

            // 獲取處理人名稱的函數
            const getAssigneeName = useCallback((assigneeId) => {
                return assignees.find(a => a.id === assigneeId)?.name || '未指派';
            }, [assignees]);

            // 根據專案狀態獲取樣式
            const getStatusStyle = (status) => {
                switch (status) {
                    case 'New': return 'bg-red-100 text-red-800';
                    case 'In Progress': return 'bg-blue-100 text-blue-800';
                    case 'Completed': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            // 渲染狀態標籤
            const StatusBadge = ({ status }) => (
                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusStyle(status)}`}>
                    {status}
                </span>
            );

            // 渲染專案列表
            const ProjectList = useMemo(() => {
                if (loading) {
                    return <p className="text-center py-10 text-gray-500">初始化中...</p>;
                }

                if (!db) {
                    return <p className="text-center py-10 text-red-500 font-semibold">資料庫連線失敗。請檢查 API Key 或權限。</p>;
                }

                return (
                    <div className="bg-white shadow overflow-hidden sm:rounded-lg mt-6">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">專案名稱</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">狀態</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">處理人</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">操作</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {projects.length === 0 ? (
                                    <tr>
                                        <td colSpan="4" className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                            目前沒有專案。
                                        </td>
                                    </tr>
                                ) : (
                                    projects.map((project) => (
                                        <tr key={project.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                {project.name}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <StatusBadge status={project.status} />
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {getAssigneeName(project.assigneeId)}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button
                                                    onClick={() => setAssigneeModalConfig({
                                                        isOpen: true,
                                                        projectId: project.id,
                                                        projectName: project.name,
                                                        currentAssigneeId: project.assigneeId
                                                    })}
                                                    className="inline-flex items-center px-3 py-1 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                                    disabled={!db}
                                                >
                                                    <Users className="w-4 h-4 mr-2" />
                                                    更換處理人
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                );
            }, [projects, loading, db, getAssigneeName]);

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        
                        {/* 頂部狀態列 */}
                        <div className="flex justify-between items-center pb-6 border-b border-gray-200">
                            <h1 className="text-3xl font-bold text-gray-900">專案管理儀表板</h1>
                            <div className="flex items-center space-x-4">
                                <div className={`px-3 py-1 rounded-full text-sm font-medium ${isDbConnected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                    DB 狀態: {isDbConnected ? '連線中' : '中斷'}
                                </div>
                                <div className="text-sm text-gray-600">
                                    使用者 UID: <span className="font-mono">{userId}</span>
                                </div>
                                <div className="text-sm text-gray-600">
                                    管理員: <span className="font-medium">{isAdmin ? '是' : '否'}</span>
                                </div>
                            </div>
                        </div>

                        {/* 通知區域 */}
                        {notification.visible && (
                            <div className={`mt-4 p-4 rounded-md flex items-center ${notification.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                {notification.type === 'success' ? <CheckCircle className="w-5 h-5 mr-3" /> : <XCircle className="w-5 h-5 mr-3" />}
                                <p className="text-sm font-medium">{notification.message}</p>
                            </div>
                        )}

                        {/* 專案列表 */}
                        {ProjectList}
                        
                        {/* 模態框容器 */}

                        {/* 1. 郵件通知模態框 (用於模擬發送郵件後的確認) */}
                        <Modal
                            isOpen={notificationModalConfig.isOpen}
                            title="模擬郵件通知"
                            onClose={() => setNotificationModalConfig({ ...notificationModalConfig, isOpen: false })}
                        >
                            <p className="text-sm text-gray-600 mb-4">這封郵件將會發送給新的處理人，以通知專案轉移。</p>
                            {notificationModalConfig.emailContent && (
                                <div className="bg-gray-50 p-4 rounded-md">
                                    <p className="text-xs text-gray-500 mb-2">收件人: {notificationModalConfig.emailContent.to}</p>
                                    <p className="text-xs text-gray-500 mb-2">主旨: {notificationModalConfig.emailContent.subject}</p>
                                    <pre className="whitespace-pre-wrap font-mono p-3 bg-white border rounded-md text-gray-700">
                                        {notificationModalConfig.emailContent.body}
                                    </pre>
                                </div>
                            )}
                        </Modal>
                        
                        {/* 2. 更換處理人模態框 */}
                        <Modal
                            isOpen={assigneeModalConfig.isOpen}
                            title="更換專案處理人"
                            onClose={() => setAssigneeModalConfig({ ...assigneeModalConfig, isOpen: false })}
                        >
                            {db && assignees.length > 0 && assigneeModalConfig.projectId && (
                                <AssigneeChangeForm
                                    db={db}
                                    projectId={assigneeModalConfig.projectId}
                                    projectName={assigneeModalConfig.projectName}
                                    currentAssigneeId={assigneeModalConfig.currentAssigneeId}
                                    assignees={assignees}
                                    onClose={() => setAssigneeModalConfig({ ...assigneeModalConfig, isOpen: false })}
                                    showNotification={showNotification}
                                    openEmailModal={openEmailModal}
                                />
                            )}
                        </Modal>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
